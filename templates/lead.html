{% extends "base.html" %}
{% block content %}

<!-- Lead Dashboard Header -->
<div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl shadow-lg p-6 text-white mb-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold">{{ user }} ({{ role }})</h1>
            <p class="text-blue-100 mt-1">Lead Dashboard - Complete financial oversight and team management</p>
        </div>
        <div class="flex items-center space-x-4">
            <div class="bg-white bg-opacity-20 rounded-lg p-3">
                <p class="text-sm opacity-90">Today</p>
                <p class="text-lg font-semibold">{{ today }}</p>
            </div>
            <button onclick="window.history.back()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </button>
            <a href="{{ url_for('logout') }}" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-colors">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </a>
        </div>
    </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="space-y-2 mb-6">
            {% for message in messages %}
                <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded relative" role="alert">
                    <span class="block sm:inline">{{ message }}</span>
                    <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="this.parentElement.style.display='none'">×</span>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<!-- Financial Overview Stats Cards -->
<div class="grid grid-cols-4 gap-4 mb-6">
    <div class="bg-blue-500 rounded-xl p-4 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-3xl font-bold" data-total-budget>₹{{ '{:,.0f}'.format(total_budget) }}</h3>
                <p class="text-blue-100 text-sm">Total Company Budget</p>
            </div>
            <div class="bg-white bg-opacity-20 rounded-lg p-2">
                <i class="fas fa-university text-2xl"></i>
            </div>
        </div>
    </div>

    <div class="bg-green-600 rounded-xl p-4 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-3xl font-bold" data-allocated>₹{{ '{:,.0f}'.format(allocated) }}</h3>
                <p class="text-green-100 text-sm">Allocated to Projects</p>
            </div>
            <div class="bg-white bg-opacity-20 rounded-lg p-2">
                <i class="fas fa-chart-line text-2xl"></i>
            </div>
        </div>
    </div>

    <div class="bg-purple-600 rounded-xl p-4 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-3xl font-bold" data-remaining>₹{{ '{:,.0f}'.format(remaining_allocation) }}</h3>
                <p class="text-purple-100 text-sm">Unallocated Budget</p>
            </div>
            <div class="bg-white bg-opacity-20 rounded-lg p-2">
                <i class="fas fa-wallet text-2xl"></i>
            </div>
        </div>
    </div>

    <div class="bg-blue-600 rounded-xl p-4 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-2xl font-bold" data-monthly-total>₹{{ '{:,.0f}'.format(total_monthly_payroll) }}/mo</h3>
                <p class="text-orange-100 text-sm" data-yearly-total>₹{{ '{:,.0f}'.format(total_yearly_payroll) }}/year</p>
            </div>
            <div class="bg-white bg-opacity-20 rounded-lg p-2">
                <i class="fas fa-users text-2xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Budget Alerts -->
{% if budget_alerts %}
<div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-lg">
    <div class="flex">
        <div class="flex-shrink-0">
            <i class="fas fa-exclamation-triangle text-yellow-400 text-xl"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-yellow-800">Budget Alerts</h3>
            <div class="mt-2 text-sm text-yellow-700">
                {% for alert in budget_alerts %}
                <p><strong>{{ alert.project }}</strong> has used <strong>{{ '{:.1f}'.format(alert.usage_percent) }}%</strong> of its budget. Remaining: ₹{{ '{:,.2f}'.format(alert.remaining) }}</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Tab Navigation -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
    <div class="border-b border-gray-200">
        <nav class="flex space-x-8 px-6" aria-label="Tabs">
            <button class="tab-button active py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600" data-tab="overview">
                <i class="fas fa-tachometer-alt mr-2"></i>Overview
            </button>
            <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="projects">
                <i class="fas fa-project-diagram mr-2"></i>Projects
            </button>
            <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="budget">
                <i class="fas fa-chart-pie mr-2"></i>Budget Summary
            </button>
            <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="expenses">
                <i class="fas fa-receipt mr-2"></i>All Expenses
            </button>
            <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="payroll">
                <i class="fas fa-money-check-alt mr-2"></i>Payroll Management
            </button>
            <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="work-history">
                <i class="fas fa-history mr-2"></i>Work History
            </button>
            <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="leave-history">
                <i class="fas fa-calendar-alt mr-2"></i>Leave History
            </button>
            {% if pending_leaves %}
            <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="approvals">
                <i class="fas fa-check-circle mr-2"></i>Pending Approvals
                <span class="ml-1 bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full">{{ pending_leaves|length }}</span>
            </button>
            {% endif %}
        </nav>
    </div>

    <!-- Tab Content -->
    <div class="p-6">
        <!-- Overview Tab -->
        <div id="overview" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Create New Project -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-800">
                            <i class="fas fa-plus text-blue-600 mr-2"></i>Create New Project
                        </h2>
                    </div>
                    <div class="p-6">
                        <form method="POST" action="{{ url_for('create_project_lead') }}" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                                <input type="text" name="project_name" required
                                       class="form-input w-full rounded-lg border-gray-300" placeholder="Enter project name">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Project Description</label>
                                <textarea name="project_desc" rows="2" required
                                          class="form-textarea w-full rounded-lg border-gray-300" placeholder="Describe the project"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cost Center</label>
                                <input type="text" name="cost_center"
                                       class="form-input w-full rounded-lg border-gray-300" placeholder="Cost center code">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Budget Amount (₹)</label>
                                <input type="number" step="0.01" name="budget_amount"
                                       class="form-input w-full rounded-lg border-gray-300" placeholder="Enter budget amount">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                                <input type="date" name="due_date" required
                                       class="form-input w-full rounded-lg border-gray-300">
                            </div>
                            <button type="submit" 
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i>Create Project
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Record Expense -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-800">
                            <i class="fas fa-plus text-green-600 mr-2"></i>Record Expense
                        </h2>
                    </div>
                    <div class="p-6">
                        <form method="POST" action="{{ url_for('record_expense_lead') }}" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Project</label>
                                <select name="project_name" id="project-select" required
                                        class="form-select w-full rounded-lg border-gray-300">
                                    <option value="">Select Project</option>
                                    {% for proj in my_projects %}
                                    <option value="{{ proj.project_name }}">{{ proj.project_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                <select name="category" required
                                        class="form-select w-full rounded-lg border-gray-300">
                                    <option value="">Select Category</option>
                                    <option value="Software">Software</option>
                                    <option value="Hardware">Hardware</option>
                                    <option value="Travel">Travel</option>
                                    <option value="Training">Training</option>
                                    <option value="Miscellaneous">Miscellaneous</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount (₹)</label>
                                <input type="number" step="0.01" name="amount" required
                                       class="form-input w-full rounded-lg border-gray-300" placeholder="Enter amount">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                <input type="date" name="expense_date" value="{{ today }}" required
                                       class="form-input w-full rounded-lg border-gray-300">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea name="description" rows="2"
                                          class="form-textarea w-full rounded-lg border-gray-300" placeholder="Optional description"></textarea>
                            </div>
                            <button type="submit" 
                                    class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i>Record Expense
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="projects" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-list text-blue-600 mr-2"></i>All Projects (Excluding Salary Projects)
                    </h2>
                </div>
                <div class="p-6">
                    {% if my_projects %}
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created By</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Budget (₹)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Used (₹)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remaining (₹)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for project in my_projects %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ project.project_name }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ project.created_by or '-' }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">₹{{ '{:,.0f}'.format(project.budget_amount or 0) }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-red-600">₹{{ '{:,.0f}'.format(project.spent_amount or 0) }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">₹{{ '{:,.0f}'.format(project.remaining_amount or 0) }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            {% if project.hr_approval_status == 'Approved' %}
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded-full">Active</span>
                                            {% elif project.hr_approval_status == 'Pending' %}
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold bg-yellow-100 text-yellow-800 rounded-full">Pending</span>
                                            {% else %}
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded-full">Rejected</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <i class="fas fa-project-diagram text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">No projects available</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Budget Summary Tab -->
        <div id="budget" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-chart-bar text-purple-600 mr-2"></i>Project Budget Summary (Excluding Salary)
                    </h2>
                    <p class="text-sm text-gray-600 mt-1">Complete budget allocation and usage across all non-salary projects</p>
                </div>
                <div class="p-6">
                    {% if budget_summary %}
                        <div class="overflow-x-auto">
                            <table id="budget-table" class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created By</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost Center</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Budget (₹)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Used (₹)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remaining (₹)</th>
                                    </tr>
                                </thead>
                                <tbody id="budget-table-body" class="bg-white divide-y divide-gray-200">
                                    {% for row in budget_summary %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ row.project_name }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ row.created_by or '-' }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ row.cost_center or '' }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">₹{{ '{:,.0f}'.format(row.total_budget) }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-red-600">₹{{ '{:,.0f}'.format(row.used_amount) }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">₹{{ '{:,.0f}'.format(row.remaining) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <i class="fas fa-chart-bar text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">No budget data available</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- All Expenses Tab -->
        <div id="expenses" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-receipt text-green-600 mr-2"></i>All Employee Expenses (Excluding Salary)
                    </h2>
                    <p class="text-sm text-gray-600 mt-1">Complete expense tracking across all employees and projects (non-salary)</p>
                </div>
                <div class="p-6">
                    {% if expenses %}
                        <div class="overflow-x-auto max-h-96">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Spent By</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (₹)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-table-body" class="bg-white divide-y divide-gray-200">
                                    {% for row in expenses %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ row.spent_by }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ row.project_name or '(non-project)' }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ row.category }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">₹{{ '{:,.2f}'.format(row.amount) }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ row.date }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ row.description or '-' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <i class="fas fa-receipt text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">No expenses recorded yet</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Payroll Management Tab -->
        <div id="payroll" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-money-check-alt text-orange-600 mr-2"></i>All Employee Payroll (Monthly & Yearly Salaries)
                    </h2>
                    <p class="text-sm text-gray-600 mt-1">Complete salary information for all active employees</p>
                </div>
                <div class="p-6">
                    {% if payment_rate_cards %}
                        <!-- Payroll Summary Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-blue-50 rounded-lg p-4">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-calendar text-blue-600 text-2xl"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-blue-600">Total Monthly Payroll</p>
                                        <p class="text-2xl font-bold text-blue-900" data-monthly-payroll-total>₹{{ '{:,.0f}'.format(total_monthly_payroll) }}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-purple-50 rounded-lg p-4">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-chart-line text-purple-600 text-2xl"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-purple-600">Total Annual Payroll</p>
                                        <p class="text-2xl font-bold text-purple-900" data-yearly-payroll-total>₹{{ '{:,.0f}'.format(total_yearly_payroll) }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="overflow-x-auto max-h-96">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employment Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monthly (₹)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Yearly (₹)</th>
                                    </tr>
                                </thead>
                                <tbody id="payroll-table-body" class="bg-white divide-y divide-gray-200">
                                    {% for emp in payment_rate_cards %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ emp.name }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                                                {% if emp.role == 'Manager' %}bg-blue-100 text-blue-800
                                                {% elif emp.role == 'Lead' %}bg-green-100 text-green-800
                                                {% elif emp.role == 'Employee' %}bg-gray-100 text-gray-800
                                                {% elif emp.role == 'Intern' %}bg-yellow-100 text-yellow-800
                                                {% else %}bg-purple-100 text-purple-800{% endif %}">
                                                {{ emp.role }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ emp.employment_type or 'Full-Time' }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">₹{{ '{:,.0f}'.format(emp.monthly_salary or 0) }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">₹{{ '{:,.0f}'.format(emp.yearly_salary or 0) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <i class="fas fa-money-check-alt text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">No payroll data available</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Work History Tab with Filters -->
        <div id="work-history" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-history text-indigo-600 mr-2"></i>All Employee Work History
                    </h2>
                    <p class="text-sm text-gray-600 mt-1">Complete work history and timesheet records for all employees</p>
                </div>
                
                <!-- Work History Filters -->
                <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                    <form method="GET" class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" name="work_start" value="{{ work_start }}"
                                   class="form-input w-full text-sm border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" name="work_end" value="{{ work_end }}"
                                   class="form-input w-full text-sm border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Employee</label>
                            <input type="text" name="work_user" value="{{ work_user }}" placeholder="Employee name"
                                   class="form-input w-full text-sm border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Project</label>
                            <input type="text" name="work_project" value="{{ work_project }}" placeholder="Project name"
                                   class="form-input w-full text-sm border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Status</label>
                            <select name="work_status" class="form-select w-full text-sm border-gray-300 rounded-md">
                                <option value="">All Status</option>
                                <option value="Approved" {% if work_status == 'Approved' %}selected{% endif %}>Approved</option>
                                <option value="Pending" {% if work_status == 'Pending' %}selected{% endif %}>Pending</option>
                                <option value="Rejected" {% if work_status == 'Rejected' %}selected{% endif %}>Rejected</option>
                            </select>
                        </div>
                        <div class="md:col-span-5 flex justify-end space-x-2">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                <i class="fas fa-filter mr-1"></i>Apply Filters
                            </button>
                            <a href="?{{ request.args|urlencode|replace('work_start=', 'x=')|replace('work_end=', 'x=')|replace('work_user=', 'x=')|replace('work_project=', 'x=')|replace('work_status=', 'x=')|replace('&x=', '')|replace('x=', '') }}" 
                               class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                                <i class="fas fa-times mr-1"></i>Clear
                            </a>
                        </div>
                    </form>
                </div>
                
                <div class="p-6">
                    {% if all_employee_work_history %}
                        <div class="overflow-x-auto max-h-96">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hours</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="work-history-table-body" class="bg-white divide-y divide-gray-200">
                                    {% for work in all_employee_work_history %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ work.username }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ work.work_date }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ work.project_name or '-' }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ work.hours }} hrs</td>
                                        <td class="px-6 py-4 text-sm text-gray-500 max-w-xs">
                                            <div class="truncate" title="{{ work.work_desc }}">{{ work.work_desc or '-' }}</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            {% if work.rm_status == 'Approved' %}
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">{{ work.rm_status }}</span>
                                            {% elif work.rm_status == 'Pending' %}
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">{{ work.rm_status }}</span>
                                            {% else %}
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">{{ work.rm_status }}</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <i class="fas fa-history text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">No work history available</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Leave History Tab with Filters -->
        <div id="leave-history" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-calendar-alt text-purple-600 mr-2"></i>All Employee Leave History
                    </h2>
                    <p class="text-sm text-gray-600 mt-1">Complete leave history records for all employees</p>
                </div>
                
                <!-- Leave History Filters -->
                <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                    <form method="GET" class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" name="leave_start" value="{{ leave_start }}"
                                   class="form-input w-full text-sm border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" name="leave_end" value="{{ leave_end }}"
                                   class="form-input w-full text-sm border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Employee</label>
                            <input type="text" name="leave_user" value="{{ leave_user }}" placeholder="Employee name"
                                   class="form-input w-full text-sm border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Leave Type</label>
                            <select name="leave_type" class="form-select w-full text-sm border-gray-300 rounded-md">
                                <option value="">All Types</option>
                                <option value="Sick" {% if leave_type == 'Sick' %}selected{% endif %}>Sick</option>
                                <option value="Vacation" {% if leave_type == 'Vacation' %}selected{% endif %}>Vacation</option>
                                <option value="Personal" {% if leave_type == 'Personal' %}selected{% endif %}>Personal</option>
                                <option value="Casual" {% if leave_type == 'Casual' %}selected{% endif %}>Casual</option>
                                <option value="Other" {% if leave_type == 'Other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Status</label>
                            <select name="leave_status" class="form-select w-full text-sm border-gray-300 rounded-md">
                                <option value="">All Status</option>
                                <option value="Approved" {% if leave_status == 'Approved' %}selected{% endif %}>Approved</option>
                                <option value="Pending" {% if leave_status == 'Pending' %}selected{% endif %}>Pending</option>
                                <option value="Rejected" {% if leave_status == 'Rejected' %}selected{% endif %}>Rejected</option>
                            </select>
                        </div>
                        <div class="md:col-span-5 flex justify-end space-x-2">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                <i class="fas fa-filter mr-1"></i>Apply Filters
                            </button>
                            <a href="?{{ request.args|urlencode|replace('leave_start=', 'x=')|replace('leave_end=', 'x=')|replace('leave_user=', 'x=')|replace('leave_type=', 'x=')|replace('leave_status=', 'x=')|replace('&x=', '')|replace('x=', '') }}" 
                               class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                                <i class="fas fa-times mr-1"></i>Clear
                            </a>
                        </div>
                    </form>
                </div>
                
                <div class="p-6">
                    {% if all_employee_leave_history %}
                        <div class="overflow-x-auto max-h-96">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Leave Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="leave-history-table-body" class="bg-white divide-y divide-gray-200">
                                    {% for leave in all_employee_leave_history %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ leave.username }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                                {% if leave.leave_type == 'Sick' %}bg-green-100 text-green-800
                                                {% elif leave.leave_type == 'Vacation' %}bg-blue-100 text-blue-800
                                                {% elif leave.leave_type == 'Personal' %}bg-purple-100 text-purple-800
                                                {% elif leave.leave_type == 'Casual' %}bg-yellow-100 text-yellow-800
                                                {% else %}bg-gray-100 text-gray-800
                                                {% endif %}">
                                                {{ leave.leave_type }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ leave.start_date }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ leave.end_date }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ leave.duration_days }} days</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            {% if leave.rm_status == 'Approved' %}
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">{{ leave.rm_status }}</span>
                                            {% elif leave.rm_status == 'Pending' %}
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">{{ leave.rm_status }}</span>
                                            {% else %}
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">{{ leave.rm_status }}</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <i class="fas fa-calendar-alt text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">No leave history available</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Pending Approvals Tab -->
        {% if pending_leaves %}
        <div id="approvals" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200 bg-red-50">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-check-circle text-red-600 mr-2"></i>Subordinates' Leave Requests Pending Approval
                        <span class="ml-2 bg-red-100 text-red-600 text-sm px-2 py-1 rounded-full">{{ pending_leaves|length }}</span>
                    </h2>
                    <p class="text-sm text-gray-600 mt-1">Leave requests from your team members awaiting approval</p>
                </div>
                <div class="p-6">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Leave Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="leaves-table-body" class="bg-white divide-y divide-gray-200">
                                {% for leave in pending_leaves %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ leave.username }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                            {% if leave.leave_type == 'Sick' %}bg-green-100 text-green-800
                                            {% elif leave.leave_type == 'Vacation' %}bg-blue-100 text-blue-800
                                            {% elif leave.leave_type == 'Personal' %}bg-purple-100 text-purple-800
                                            {% elif leave.leave_type == 'Casual' %}bg-yellow-100 text-yellow-800
                                            {% else %}bg-gray-100 text-gray-800
                                            {% endif %}">
                                            {{ leave.leave_type }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ leave.start_date }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ leave.end_date }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ leave.duration_days }} days</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <form method="POST" action="{{ url_for('approve_leave_action') }}" style="display: inline;" class="mr-2">
                                            <input type="hidden" name="id" value="{{ leave.id }}">
                                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                                <i class="fas fa-check mr-1"></i>Approve
                                            </button>
                                        </form>
                                        <button onclick="rejectLeave({{ leave.id }})" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                            <i class="fas fa-times mr-1"></i>Reject
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal for Reject Leave -->
<div id="rejectLeaveModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg font-medium text-gray-900">Reject Leave Request</h3>
            <form method="POST" action="{{ url_for('reject_leave_action') }}" class="mt-4">
                <input type="hidden" name="id" id="rejectLeaveId">
                <div class="mt-2 px-7 py-3">
                    <textarea name="reason" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4" placeholder="Please provide a reason for rejection..." required></textarea>
                </div>
                <div class="items-center px-4 py-3">
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-24 mr-2 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300">
                        Reject
                    </button>
                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-24 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Enhanced JavaScript for filtering and tab functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.getAttribute('data-tab');
            
            // Update button styles
            tabButtons.forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-blue-600');
                btn.classList.add('text-gray-500', 'border-transparent');
            });
            
            button.classList.add('text-blue-600', 'border-blue-600');
            button.classList.remove('text-gray-500', 'border-transparent');
            
            // Update content visibility
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(tabId).classList.remove('hidden');
        });
    });

    // Auto-update functionality with improved error handling
    function updateAllDashboardData() {
        fetch('/api/lead_dashboard_data')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    return;
                }
                
                // Update financial overview
                updateFinancialOverview(data);
                
                // Update all tables
                updateBudgetTable(data.budget_summary);
                updateExpensesTable(data.expenses);
                updatePayrollTable(data.payment_rate_cards);
                updateWorkHistoryTable(data.all_employee_work_history);
                updateLeaveHistoryTable(data.all_employee_leave_history);
                
                // Show update indicator
                showUpdateIndicator();
            })
            .catch(error => {
                console.error('Error fetching dashboard data:', error);
                showErrorIndicator();
            });
    }

    // Update functions
    function updateFinancialOverview(data) {
        const totalBudgetEl = document.querySelector('[data-total-budget]');
        const allocatedEl = document.querySelector('[data-allocated]');
        const remainingEl = document.querySelector('[data-remaining]');
        const monthlyTotalEl = document.querySelector('[data-monthly-total]');
        const yearlyTotalEl = document.querySelector('[data-yearly-total]');
        
        if (totalBudgetEl) totalBudgetEl.textContent = `₹${data.total_budget.toLocaleString('en-IN')}`;
        if (allocatedEl) allocatedEl.textContent = `₹${data.allocated.toLocaleString('en-IN')}`;
        if (remainingEl) remainingEl.textContent = `₹${data.remaining_allocation.toLocaleString('en-IN')}`;
        if (monthlyTotalEl) monthlyTotalEl.textContent = `₹${data.total_monthly_payroll.toLocaleString('en-IN')}/mo`;
        if (yearlyTotalEl) yearlyTotalEl.textContent = `₹${data.total_yearly_payroll.toLocaleString('en-IN')}/year`;
    }

    function updateBudgetTable(budgetData) {
        const tbody = document.getElementById('budget-table-body');
        if (!tbody || !budgetData) return;
        
        tbody.innerHTML = '';
        budgetData.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.project_name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.created_by || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.cost_center || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">₹${row.total_budget.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-red-600">₹${row.used_amount.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">₹${row.remaining.toLocaleString('en-IN')}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateExpensesTable(expensesData) {
        const tbody = document.getElementById('expenses-table-body');
        if (!tbody || !expensesData) return;
        
        tbody.innerHTML = '';
        expensesData.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.spent_by}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.project_name || '(non-project)'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.category}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">₹${row.amount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.date}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.description || '-'}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updatePayrollTable(payrollData) {
        const tbody = document.getElementById('payroll-table-body');
        if (!tbody || !payrollData) return;
        
        // Update totals
        const monthlyTotal = document.querySelector('[data-monthly-payroll-total]');
        const yearlyTotal = document.querySelector('[data-yearly-payroll-total]');
        
        const totalMonthly = payrollData.reduce((sum, emp) => sum + (emp.monthly_salary || 0), 0);
        const totalYearly = payrollData.reduce((sum, emp) => sum + (emp.yearly_salary || 0), 0);
        
        if (monthlyTotal) monthlyTotal.textContent = `₹${totalMonthly.toLocaleString('en-IN')}`;
        if (yearlyTotal) yearlyTotal.textContent = `₹${totalYearly.toLocaleString('en-IN')}`;
        
        tbody.innerHTML = '';
        payrollData.forEach(emp => {
            const roleClass = emp.role === 'Manager' ? 'bg-blue-100 text-blue-800' :
                            emp.role === 'Lead' ? 'bg-green-100 text-green-800' :
                            emp.role === 'Employee' ? 'bg-gray-100 text-gray-800' :
                            emp.role === 'Intern' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-purple-100 text-purple-800';
            
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${emp.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${roleClass}">
                        ${emp.role}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${emp.employment_type || 'Full-Time'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">₹${(emp.monthly_salary || 0).toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">₹${(emp.yearly_salary || 0).toLocaleString('en-IN')}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateWorkHistoryTable(workData) {
        const tbody = document.getElementById('work-history-table-body');
        if (!tbody || !workData) return;
        
        tbody.innerHTML = '';
        workData.forEach(work => {
            const statusClass = work.rm_status === 'Approved' ? 'bg-green-100 text-green-800' :
                              work.rm_status === 'Pending' ? 'bg-yellow-100 text-yellow-800' :
                              'bg-red-100 text-red-800';
            
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${work.username}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${work.work_date}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${work.project_name || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${work.hours} hrs</td>
                <td class="px-6 py-4 text-sm text-gray-500 max-w-xs">
                    <div class="truncate" title="${work.work_desc || ''}">${work.work_desc || '-'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${work.rm_status}</span>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateLeaveHistoryTable(leaveData) {
        const tbody = document.getElementById('leave-history-table-body');
        if (!tbody || !leaveData) return;
        
        tbody.innerHTML = '';
        leaveData.forEach(leave => {
            const typeClass = leave.leave_type === 'Sick' ? 'bg-green-100 text-green-800' :
                            leave.leave_type === 'Vacation' ? 'bg-blue-100 text-blue-800' :
                            leave.leave_type === 'Personal' ? 'bg-purple-100 text-purple-800' :
                            leave.leave_type === 'Casual' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-gray-100 text-gray-800';
            
            const statusClass = leave.rm_status === 'Approved' ? 'bg-green-100 text-green-800' :
                              leave.rm_status === 'Pending' ? 'bg-yellow-100 text-yellow-800' :
                              'bg-red-100 text-red-800';
            
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${leave.username}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${typeClass}">
                        ${leave.leave_type}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${leave.start_date}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${leave.end_date}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${leave.duration_days} days</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${leave.rm_status}</span>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function showUpdateIndicator() {
        // You can add a small indicator that data was updated
        const indicator = document.createElement('div');
        indicator.className = 'fixed top-4 right-4 bg-green-500 text-white px-3 py-1 rounded-md text-sm z-50';
        indicator.textContent = 'Data updated';
        document.body.appendChild(indicator);
        
        setTimeout(() => {
            indicator.remove();
        }, 2000);
    }

    function showErrorIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'fixed top-4 right-4 bg-red-500 text-white px-3 py-1 rounded-md text-sm z-50';
        indicator.textContent = 'Update failed';
        document.body.appendChild(indicator);
        
        setTimeout(() => {
            indicator.remove();
        }, 3000);
    }

    // Poll for updates every 10 seconds
    setInterval(updateAllDashboardData, 10000);
    
    // Initial update after 2 seconds
    setTimeout(updateAllDashboardData, 2000);
});

// Modal functions
function rejectLeave(leaveId) {
    document.getElementById('rejectLeaveId').value = leaveId;
    document.getElementById('rejectLeaveModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('rejectLeaveModal').classList.add('hidden');
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('rejectLeaveModal');
    if (event.target == modal) {
        modal.classList.add('hidden');
    }
}

// Flash message auto-hide
setTimeout(function() {
    const alerts = document.querySelectorAll('.bg-blue-100');
    alerts.forEach(alert => {
        alert.style.transition = 'opacity 0.5s';
        alert.style.opacity = '0';
        setTimeout(() => alert.remove(), 500);
    });
}, 5000);
</script>

<style>
.form-input, .form-select, .form-textarea {
    display: block;
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    line-height: 1.25rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.tab-button.active {
    border-bottom-color: #2563eb;
    color: #2563eb;
}

.tab-button {
    transition: all 0.2s;
}

.tab-button:hover {
    color: #374151;
    border-bottom-color: #d1d5db;
}

.transition-colors {
    transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, color 0.15s ease-in-out;
}

.overflow-x-auto {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
}

.overflow-x-auto::-webkit-scrollbar { height: 6px; }
.overflow-x-auto::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
.overflow-x-auto::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
.overflow-x-auto::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

tbody tr:hover {
    background-color: #f9fafb;
}

.truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
</style>
{% endblock %}
