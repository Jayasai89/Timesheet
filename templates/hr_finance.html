{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
    <!-- Header with User Info and Logout -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold">{{ user }}( HR & Finance Controller )</h1>
                <p class="text-blue-100 mt-1">HR & Finance Dashboard - Complete financial oversight and management</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="bg-white bg-opacity-20 rounded-lg p-3">
                    <p class="text-sm opacity-90">Today</p>
                    <p class="text-lg font-semibold">{{ today }}</p>
                </div>
                <a href="{{ url_for('logout') }}" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </a>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="space-y-2">
                {% for message in messages %}
                    <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded relative" role="alert">
                        <span class="block sm:inline">{{ message }}</span>
                        <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="this.parentElement.style.display='none'">Ã—</span>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

   <!-- Financial Stats Cards (FIXED - Shows remaining budget changes) -->
<!-- UPDATED Financial Stats Cards -->
<div class="grid grid-cols-4 gap-4 mb-6">
    <div class="bg-green-500 rounded-xl p-4 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-2xl font-bold" id="totalBudgetDisplay">â‚¹{{ "{:,.0f}".format(total_budget|default(0)|float) }}</h3>
                <p class="text-green-100 text-sm">Total Company Budget</p>
                <p class="text-green-200 text-xs mt-1">ðŸ“Œ Fixed Amount</p>
                <button onclick="editTotalBudget()" class="mt-1 text-xs bg-white bg-opacity-20 hover:bg-opacity-30 px-2 py-1 rounded">
                    <i class="fas fa-edit mr-1"></i>Edit
                </button>
            </div>
            <div class="bg-white bg-opacity-20 rounded-lg p-2">
                <i class="fas fa-rupee-sign text-2xl"></i>
            </div>
        </div>
    </div>

    <div class="bg-blue-500 rounded-xl p-4 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-2xl font-bold">â‚¹{{ "{:,.0f}".format(project_allocated|default(0)|float) }}</h3>
                <p class="text-blue-100 text-sm">Allocated to Projects</p>
                <p class="text-blue-200 text-xs mt-1">ðŸ“ˆ Real project budgets only</p>
            </div>
            <div class="bg-white bg-opacity-20 rounded-lg p-2">
                <i class="fas fa-project-diagram text-2xl"></i>
            </div>
        </div>
    </div>

    <div class="bg-purple-500 rounded-xl p-4 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-2xl font-bold">â‚¹{{ "{:,.0f}".format(payroll_asset_allocated|default(0)|float) }}</h3>
                <p class="text-purple-100 text-sm">Allocated to Payroll & Assets</p>
                <p class="text-purple-200 text-xs mt-1">ðŸ‘¥ Salaries + Assets</p>
            </div>
            <div class="bg-white bg-opacity-20 rounded-lg p-2">
                <i class="fas fa-users text-2xl"></i>
            </div>
        </div>
    </div>

    <div class="bg-blue-500 rounded-xl p-4 text-white cursor-pointer hover:bg-orange-600 transition-colors" onclick="showBudgetUsageDetails()">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-2xl font-bold" id="remainingBudgetDisplay">â‚¹{{ "{:,.0f}".format(remaining_allocation|default(0)|float) }}</h3>
                <p class="text-blue-100 text-sm">Remaining Budget</p>
                <p class="text-orange-200 text-xs mt-1">ðŸ’° Available for allocation</p>
                
            </div>
            <div class="bg-white bg-opacity-20 rounded-lg p-2">
                <i class="fas fa-wallet text-2xl"></i>
            </div>
        </div>
    </div>
</div>


<!-- Budget Usage Details Modal (UPDATED with search filter) -->
<div id="budgetUsageModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-96">
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800">Budget Usage Details</h3>
            <button onclick="closeBudgetUsageModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6 overflow-y-auto max-h-80">
            <!-- Add search filter -->
            <div class="mb-4">
                <input type="text" id="budgetFilter" onkeyup="filterBudgetTable()" 
                       placeholder="Search by project name, type, description..." 
                       class="form-input w-full rounded-lg border-gray-300" 
                       style="padding: 8px; border: 1px solid #d1d5db; border-radius: 8px;" />
            </div>
            <div id="budgetUsageContent">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
                    <p class="text-gray-500 mt-2">Loading usage details...</p>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Edit Total Budget Modal -->
    <div id="editBudgetModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Edit Total Company Budget</h3>
                <button onclick="closeBudgetModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                <p class="text-sm text-blue-700">
                    <strong>Current Budget:</strong> â‚¹{{ "{:,.2f}".format(total_budget|default(0)|float) }}
                </p>
                <p class="text-sm text-blue-600">
                    <strong>Allocated:</strong> â‚¹{{ "{:,.2f}".format(allocated|default(0)|float) }} | 
                    <strong>Available:</strong> â‚¹{{ "{:,.2f}".format(remaining_allocation|default(0)|float) }}
                </p>
            </div>
            
            <form method="post" action="{{ url_for('update_total_budget_action') }}">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">New Total Company Budget (â‚¹)</label>
                    <input type="number" name="total_budget" step="0.01" required 
                           value="{{ total_budget|default(5000000)|float }}" 
                           min="0"
                           class="form-input w-full rounded-lg border-gray-300">
                    <p class="text-xs text-gray-500 mt-1">Note: New budget should be at least â‚¹{{ "{:,.0f}".format(allocated|default(0)|float) }} (current allocated amount)</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Change</label>
                    <textarea name="change_reason" rows="3" required
                              class="form-textarea w-full rounded-lg border-gray-300"
                              placeholder="Please specify reason for budget change..."></textarea>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">
                        <i class="fas fa-save mr-1"></i>Update Budget
                    </button>
                    <button type="button" onclick="closeBudgetModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
        <div class="border-b border-gray-200">
            <nav class="flex space-x-8 px-6" aria-label="Tabs">
                <button class="tab-button active py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600" data-tab="overview">
                    <i class="fas fa-tachometer-alt mr-2"></i>Overview
                </button>
                <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="project-management">
                    <i class="fas fa-project-diagram mr-2"></i>Project Management
                </button>
                <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="budget-management">
                    <i class="fas fa-coins mr-2"></i>Budget Management
                </button>
                <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="expense-tracking">
                    <i class="fas fa-receipt mr-2"></i>Expense Tracking
                </button>
                <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="project-approvals">
                    <i class="fas fa-check-circle mr-2"></i>Project Approvals
                </button>
                <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="payroll">
                    <i class="fas fa-users mr-2"></i>Payroll Management
                </button>
                <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="asset-approvals">
                    <i class="fas fa-tools mr-2"></i>Asset Approvals
                    {% if asset_requests %}
                        {% set pending_count = asset_requests|selectattr("status", "equalto", "Pending")|list|length %}
                        {% if pending_count > 0 %}
                            <span class="ml-1 bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full">{{ pending_count }}</span>
                        {% endif %}
                    {% endif %}
                </button>
                <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="team-approvals">
                    <i class="fas fa-user-check mr-2"></i>Team Approvals
                    {% if pending_team_work or pending_team_leaves %}
                        <span class="ml-1 bg-yellow-100 text-yellow-600 text-xs px-2 py-1 rounded-full">
                            {{ (pending_team_work|length + pending_team_leaves|length) }}
                        </span>
                    {% endif %}
                </button>
                <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="employee-records">
                    <i class="fas fa-history mr-2"></i>Employee Records
                </button>
                <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="work-assignments">
                    <i class="fas fa-tasks mr-2"></i>Work Assignments
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="p-6">
            <!-- Overview Tab -->
            <div id="overview" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Main Content Area -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Budget Allocation Chart -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="px-6 py-4 border-b border-gray-200">
                                <h2 class="text-lg font-semibold text-gray-800">
                                    <i class="fas fa-chart-pie text-blue-600 mr-2"></i>Budget Allocation Summary
                                </h2>
                            </div>
                            <div class="p-6">
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    <div class="text-center p-4 bg-green-50 rounded-lg">
                                        <h4 class="text-lg font-semibold text-green-800">Total Budget</h4>
                                        <p class="text-2xl font-bold text-green-600">â‚¹{{ "{:,.2f}".format(total_budget|default(0)|float) }}</p>
                                    </div>
                                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                                        <h4 class="text-lg font-semibold text-blue-800">Projects</h4>
                                        <p class="text-2xl font-bold text-blue-600">â‚¹{{ "{:,.2f}".format(project_allocated|default(0)|float) }}</p>
                                        <p class="text-sm text-blue-500">{{ "{:.1f}".format((project_allocated/total_budget)*100 if total_budget and total_budget > 0 else 0) }}%</p>
                                    </div>
                                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                                        <h4 class="text-lg font-semibold text-purple-800">Payroll & Assets</h4>
                                        <p class="text-2xl font-bold text-purple-600">â‚¹{{ "{:,.2f}".format(payroll_asset_allocated|default(0)|float) }}</p>
                                        <p class="text-sm text-purple-500">{{ "{:.1f}".format((payroll_asset_allocated/total_budget)*100 if total_budget and total_budget > 0 else 0) }}%</p>
                                    </div>
                                    <div class="text-center p-4 bg-orange-50 rounded-lg">
                                        <h4 class="text-lg font-semibold text-orange-800">Remaining</h4>
                                        <p class="text-2xl font-bold text-orange-600">â‚¹{{ "{:,.2f}".format(remaining_allocation|default(0)|float) }}</p>
                                        <p class="text-sm text-orange-500">{{ "{:.1f}".format((remaining_allocation/total_budget)*100 if total_budget and total_budget > 0 else 0) }}%</p>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- Project Budget Overview -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="px-6 py-4 border-b border-gray-200">
                                <h2 class="text-lg font-semibold text-gray-800">
                                    <i class="fas fa-project-diagram text-green-600 mr-2"></i>Project Budget Overview
                                </h2>
                            </div>
                            <div class="p-6">
                                {% if budget_summary %}
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created By</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost Center</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Budget (â‚¹)</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Used (â‚¹)</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remaining (â‚¹)</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">
                                                {% for row in budget_summary %}
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ row.project_name }}</td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ row.created_by or 'N/A' }}</td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ row.cost_center or 'N/A' }}</td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">â‚¹{{ "{:,.2f}".format(row.total_budget|default(0)|float) }}</td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">â‚¹{{ "{:,.2f}".format(row.used_amount|default(0)|float) }}</td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">â‚¹{{ "{:,.2f}".format(row.remaining|default(0)|float) }}</td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                                                        {% set usage_percent = (row.used_amount / row.total_budget * 100) if row.total_budget and row.total_budget > 0 else 0 %}
                                                        {% if usage_percent < 50 %}
                                                            <span class="inline-flex px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded-full">
                                                                <i class="fas fa-check mr-1"></i>On Track
                                                            </span>
                                                        {% elif usage_percent < 80 %}
                                                            <span class="inline-flex px-2 py-1 text-xs font-semibold bg-yellow-100 text-yellow-800 rounded-full">
                                                                <i class="fas fa-exclamation mr-1"></i>Caution
                                                            </span>
                                                        {% else %}
                                                            <span class="inline-flex px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded-full">
                                                                <i class="fas fa-times mr-1"></i>Over Budget
                                                            </span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="text-center py-6">
                                        <i class="fas fa-chart-pie text-3xl text-gray-300 mb-3"></i>
                                        <p class="text-gray-500">No budget data available</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Right Sidebar -->
                    <div class="space-y-6">
                        <!-- Recent Financial Activity -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="px-6 py-4 border-b border-gray-200">
                                <h2 class="text-lg font-semibold text-gray-800">
                                    <i class="fas fa-chart-line text-yellow-600 mr-2"></i>Recent Activity
                                </h2>
                            </div>
                            <div class="p-6">
                                <div class="space-y-3">
                                    {% if expense_summary %}
                                        {% for expense in expense_summary[:5] %}
                                        <div class="flex items-center space-x-3 text-sm">
                                            <div class="flex-shrink-0">
                                                <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                                            </div>
                                            <div class="flex-1">
                                                <p class="text-gray-800">Expense: â‚¹{{ "{:,.2f}".format(expense.amount|default(0)|float) }}</p>
                                                <p class="text-gray-500 text-xs">{{ expense.category }} - {{ expense.spent_by }}</p>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {% if pending_projects %}
                                        {% for project in pending_projects[:3] %}
                                        <div class="flex items-center space-x-3 text-sm">
                                            <div class="flex-shrink-0">
                                                <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                            </div>
                                            <div class="flex-1">
                                                <p class="text-gray-800">Project Approved</p>
                                                <p class="text-gray-500 text-xs">{{ project.project_name }} by {{ project.created_by }}</p>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {% if not expense_summary and not pending_projects %}
                                        <div class="text-center py-4">
                                            <i class="fas fa-chart-line text-2xl text-gray-300 mb-2"></i>
                                            <p class="text-gray-500 text-sm">No recent activity</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="px-6 py-4 border-b border-gray-200">
                                <h2 class="text-lg font-semibold text-gray-800">
                                    <i class="fas fa-bolt text-yellow-600 mr-2"></i>Quick Actions
                                </h2>
                            </div>
                            <div class="p-6 space-y-3">
                                <button onclick="downloadFinancialReport()" 
                                        class="w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                                    <div class="flex items-center">
                                        <i class="fas fa-download text-gray-600 mr-3"></i>
                                        <span class="text-sm font-medium text-gray-700">Download Financial Report</span>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </button>
                                
                                <button onclick="exportBudgetData()" 
                                        class="w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                                    <div class="flex items-center">
                                        <i class="fas fa-file-excel text-gray-600 mr-3"></i>
                                        <span class="text-sm font-medium text-gray-700">Export Budget Data</span>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </button>
                                
                                <button onclick="generatePayrollReport()" 
                                        class="w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                                    <div class="flex items-center">
                                        <i class="fas fa-users text-gray-600 mr-3"></i>
                                        <span class="text-sm font-medium text-gray-700">Generate Payroll Report</span>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW Project Management Tab -->
            <div id="project-management" class="tab-content hidden">
                <div class="space-y-6">
                    <!-- Create New Project -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-plus text-blue-600 mr-2"></i>Create New Project
                            </h2>
                            <p class="text-sm text-gray-600 mt-1">Create new projects and manage existing ones</p>
                        </div>
                        <div class="p-6">
                            <form method="post" action="{{ url_for('create_project_hr') }}" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                                        <input type="text" name="project_name" required
                                               class="form-input w-full rounded-lg border-gray-300"
                                               placeholder="Enter project name">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cost Center</label>
                                        <input type="text" name="cost_center" required
                                               class="form-input w-full rounded-lg border-gray-300"
                                               placeholder="e.g., IT, Marketing, Operations">
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                                        <input type="date" name="start_date" required
                                               class="form-input w-full rounded-lg border-gray-300">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                        <input type="date" name="end_date" required
                                               class="form-input w-full rounded-lg border-gray-300">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Project Description</label>
                                    <textarea name="project_description" rows="3" required
                                              class="form-textarea w-full rounded-lg border-gray-300"
                                              placeholder="Describe the project objectives and scope..."></textarea>
                                </div>
                                
                                <button type="submit" 
                                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Create Project
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- All Projects Management -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-list text-green-600 mr-2"></i>All Projects
                            </h2>
                        </div>
                        <div class="p-6">
                            {% if all_projects %}
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Name</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created By</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost Center</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Budget (â‚¹)</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            {% for project in all_projects %}
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ project.project_name }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ project.created_by }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ project.cost_center or 'N/A' }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">â‚¹{{ "{:,.2f}".format(project.budget_amount or 0) }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    {% set status = project.hr_approval_status|lower if project.hr_approval_status else '' %}
                                                    {% if status == 'approved' %}
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded-full">
                                                            <i class="fas fa-check mr-1"></i>Approved
                                                        </span>
                                                    {% elif status == 'pending' %}
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold bg-yellow-100 text-yellow-800 rounded-full">
                                                            <i class="fas fa-clock mr-1"></i>Pending
                                                        </span>
                                                    {% elif status == 'rejected' %}
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded-full">
                                                            <i class="fas fa-times mr-1"></i>Rejected
                                                        </span>
                                                    {% else %}
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold bg-gray-100 text-gray-800 rounded-full">
                                                            <i class="fas fa-question mr-1"></i>{{ project.hr_approval_status|default('Unknown')|title }}
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                    <button class="text-blue-600 hover:text-blue-800 text-xs" 
                                                            onclick="editProject('{{ project.project_name }}', '{{ project.cost_center }}', '{{ project.description }}')">
                                                        <i class="fas fa-edit mr-1"></i>Edit
                                                    </button>
                                                    {% if project.hr_approval_status != 'Approved' %}
                                                    <form method="post" action="{{ url_for('delete_project_hr') }}" style="display: inline;">
                                                        <input type="hidden" name="project_id" value="{{ project.project_id }}">
                                                        <button type="submit" class="text-red-600 hover:text-red-800 text-xs"
                                                                onclick="return confirm('Are you sure you want to delete this project?')">
                                                            <i class="fas fa-trash mr-1"></i>Delete
                                                        </button>
                                                    </form>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-8">
                                    <i class="fas fa-project-diagram text-4xl text-gray-300 mb-4"></i>
                                    <p class="text-gray-500">No projects found</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Management Tab -->
            <div id="budget-management" class="tab-content hidden">
                <div class="space-y-6">
                    <!-- Budget Allocation Form -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-plus text-blue-600 mr-2"></i>Allocate Budget to Approved Project
                            </h2>
                            <p class="text-sm text-gray-600 mt-1">Assign budget to approved projects without budget allocation (Available: â‚¹{{ "{:,.2f}".format(remaining_allocation|default(0)|float) }})</p>
                        </div>
                        <div class="p-6">
                            <form method="post" action="{{ url_for('allocate_budget_action') }}" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Approved Project</label>
                                        <select name="project_name" required class="form-select w-full rounded-lg border-gray-300">
                                            <option value="">Select Approved Project</option>
                                            {% for project in projects_needing_budget %}
                                                <option value="{{ project.project_name }}">
                                                    {{ project.project_name }} (by {{ project.created_by }})
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">Only approved projects without budget allocation are shown</p>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Budget Amount (â‚¹)</label>
                                        <input type="number" name="budget_amount" step="0.01" required
                                               max="{{ remaining_allocation|default(0)|float }}"
                                               class="form-input w-full rounded-lg border-gray-300"
                                               placeholder="Enter amount">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cost Center</label>
                                        <input type="text" name="cost_center" required
                                               class="form-input w-full rounded-lg border-gray-300"
                                               placeholder="e.g., IT, Marketing">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Budget Notes</label>
                                    <textarea name="notes" rows="3" 
                                              class="form-textarea w-full rounded-lg border-gray-300"
                                              placeholder="Optional notes about this budget allocation..."></textarea>
                                </div>
                                
                                <button type="submit" 
                                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Allocate Budget
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Current Budget Allocations -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-list text-green-600 mr-2"></i>Current Budget Allocations
                            </h2>
                        </div>
                        <div class="p-6">
                            {% if budget_summary %}
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created By</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost Center</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Budget (â‚¹)</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Used (â‚¹)</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remaining (â‚¹)</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usage %</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            {% for row in budget_summary %}
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ row.project_name }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ row.created_by or 'N/A' }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ row.cost_center or 'N/A' }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">â‚¹{{ "{:,.2f}".format(row.total_budget|default(0)|float) }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">â‚¹{{ "{:,.2f}".format(row.used_amount|default(0)|float) }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">â‚¹{{ "{:,.2f}".format(row.remaining|default(0)|float) }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    {% set usage_percent = (row.used_amount / row.total_budget * 100) if row.total_budget and row.total_budget > 0 else 0 %}
                                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                                                        {% if usage_percent < 50 %}bg-green-100 text-green-800
                                                        {% elif usage_percent < 80 %}bg-yellow-100 text-yellow-800
                                                        {% else %}bg-red-100 text-red-800{% endif %}">
                                                        {{ "{:.1f}".format(usage_percent) }}%
                                                    </span>
                                                </td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                    <button class="text-blue-600 hover:text-blue-800 text-xs" 
                                                            onclick="editBudgetAllocation('{{ row.project_name }}', {{ row.total_budget|default(0)|float }}, '{{ row.cost_center }}')">
                                                        <i class="fas fa-edit mr-1"></i>Edit
                                                    </button>
                                                    <button class="text-red-600 hover:text-red-800 text-xs"
                                                            onclick="removeBudgetAllocation('{{ row.project_name }}')">
                                                        <i class="fas fa-trash mr-1"></i>Remove
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-8">
                                    <i class="fas fa-coins text-4xl text-gray-300 mb-4"></i>
                                    <p class="text-gray-500">No budget allocations found</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expense Tracking Tab -->
            <div id="expense-tracking" class="tab-content hidden">
                <div class="space-y-6">
                    <!-- Add this expense recording form to the expense tracking tab -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-plus text-green-600 mr-2"></i>Record New Expense
                            </h2>
                        </div>
                        <div class="p-6">
                            <form method="post" action="{{ url_for('hr_record_expense_action') }}" class="space-y-4" enctype="multipart/form-data">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Project</label>
                                        <select name="project" class="form-select w-full rounded-lg border-gray-300">
                                            <option value="(non-project)">(non-project)</option>
                                            {% for project in all_projects %}
                                                <option value="{{ project.project_name }}">{{ project.project_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                                                    <select name="category" id="expense-category-select" class="form-select w-full rounded-lg border-gray-300" onchange="toggleOtherCategoryField()">
    <option value="Travel">Travel</option>
    <option value="Equipment">Equipment</option>
    <option value="Software">Software</option>
    <option value="Training">Training</option>
    <option value="Resources">Resources</option>
    <option value="For email">For email</option>
    <option value="Github">Github</option>
    <option value="Api">Api</option>
    <option value="Other">Other</option>
</select>
</div>
<!-- Add this NEW "Other Category" field right after the category dropdown -->
<div id="other-category-field" class="hidden">
    <label class="block text-sm font-medium text-gray-700 mb-2">
        <i class="fas fa-tag mr-1"></i>Specify Other Category
    </label>
    <input type="text" 
           name="other_category" 
           id="other-category-input"
           placeholder="Enter custom category name..."
           class="form-input w-full rounded-lg border-gray-300">
    <p class="text-xs text-gray-500 mt-1">This will be used as the category for your expense</p>
</div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Amount (â‚¹)</label>
                                        <input type="number" name="amount" step="0.01" required
                                            class="form-input w-full rounded-lg border-gray-300">
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                        <input type="date" name="exp_date" value="{{ today }}"
                                            class="form-input w-full rounded-lg border-gray-300">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                        <input type="text" name="desc" required
                                            class="form-input w-full rounded-lg border-gray-300">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-paperclip mr-1"></i>Expense Document (Optional)
                                    </label>
                                    <input type="file" name="expense_document" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx"
                                        class="form-input w-full rounded-lg border-gray-300">
                                    <p class="text-xs text-gray-500 mt-1">Supported: PDF, Images, Word, Excel files</p>
                                </div>
                                
                                <button type="submit" 
                                        class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Record Expense
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Expense Filters -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-filter text-blue-600 mr-2"></i>Filter Expenses
                            </h2>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input type="text" id="expenseUserFilter" placeholder="Filter by user..." 
                                       class="form-input rounded-lg border-gray-300" 
                                       onkeyup="filterTable('expenseTable', 'expenseUserFilter', 1)">
                                <input type="text" id="expenseProjectFilter" placeholder="Filter by project..." 
                                       class="form-input rounded-lg border-gray-300" 
                                       onkeyup="filterTable('expenseTable', 'expenseProjectFilter', 2)">
                                                              <select id="expenseCategoryFilter" class="form-select rounded-lg border-gray-300" onchange="filterTable('expenseTable', 'expenseCategoryFilter', 3)">
    <option value="">All Categories</option>
    <option value="travel">Travel</option>
    <option value="equipment">Equipment</option>
    <option value="software">Software</option>
    <option value="training">Training</option>
    <option value="Resources">Resources</option>
    <option value="For email">For email</option>
    <option value="Github">Github</option>
    <option value="Api">Api</option>
    <option value="other">Other Categories</option>
</select>
                                <input type="date" id="expenseDateFilter" placeholder="Filter by date..." 
                                       class="form-input rounded-lg border-gray-300" 
                                       onchange="filterTable('expenseTable', 'expenseDateFilter', 6)">
                            </div>
                        </div>
                    </div>

                    <!-- All Expenses Table -->
                    <!-- All Company Expenses Table - ENHANCED WITH EDIT/DELETE -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200">
    <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-800">
            <i class="fas fa-receipt text-green-600 mr-2"></i>All Company Expenses
        </h2>
    </div>
    <div class="p-6">
        {% if expensesummary %}
        <div class="overflow-x-auto max-h-96 border rounded-lg">
            <table id="expenseTable" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Spent By</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount â‚¹</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for expense in expensesummary %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ expense.id }}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-8 w-8">
                                    <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center">
                                        <span class="text-xs font-medium text-blue-600">{{ expense.spent_by[0]|upper }}</span>
                                    </div>
                                </div>
                                <div class="ml-3">
                                    <div class="text-sm font-medium text-gray-900">{{ expense.spent_by }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ expense.project_name or 'non-project' }}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold bg-gray-100 text-gray-800 rounded-full">{{ expense.category }}</span>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">â‚¹{{ "{:,.2f}".format(expense.amount|default(0)|float) }}</td>
                        <td class="px-4 py-4 text-sm text-gray-900 max-w-xs">
                            <div class="truncate" title="{{ expense.description }}">{{ expense.description }}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ expense.date }}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm">
                            {% if expense.document_path %}
                            <div class="flex space-x-2">
                                <a href="{{ url_for('view_expense_document', expense_id=expense.id) }}" target="_blank" 
                                   class="text-blue-600 hover:text-blue-800 text-xs px-2 py-1 bg-blue-50 rounded-md">
                                    <i class="fas fa-eye mr-1"></i>View
                                </a>
                            </div>
                            {% else %}
                            <span class="text-gray-400 text-xs">No document</span>
                            {% endif %}
                        </td>
                        <!-- NEW: Actions Column -->
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <!-- Edit Button -->
  <button onclick="editExpense('{{ expense.id }}', '{{ expense.projectname }}', '{{ expense.category }}', '{{ expense.amount }}', '{{ expense.date }}', '{{ expense.description }}', '{{ expense.documentpath }}')" 
        class="text-blue-600 hover:text-blue-800 text-xs px-2 py-1 bg-blue-50 rounded-md">
    <i class="fas fa-edit mr-1"></i>Edit
</button>


                                
                                <!-- Delete Button -->
                                <button onclick="deleteExpense({{ expense.id }}, '{{ expense.description }}')" 
                                        class="text-red-600 hover:text-red-800 text-xs px-2 py-1 bg-red-50 hover:bg-red-100 rounded-md border border-red-200 transition-colors">
                                    <i class="fas fa-trash mr-1"></i>Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="mt-4 text-sm text-gray-500">
            <i class="fas fa-info-circle mr-1"></i>
            Showing {{ expensesummary|length }} expense records
        </div>
        {% else %}
        <div class="text-center py-12">
            <i class="fas fa-receipt text-4xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-800 mb-2">No Expenses Found</h3>
            <p class="text-gray-500">No expense records found in the system.</p>
        </div>
        {% endif %}
    </div>
</div>
    </div>

<!-- Edit Expense Modal - COMPLETE VERSION -->
<div id="editExpenseModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
    <div class="flex items-start justify-center min-h-screen p-4 py-8">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg my-8">
            
            <!-- Header - Fixed -->
            <div class="px-6 py-4 border-b border-gray-200 bg-white rounded-t-xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-edit mr-2 text-blue-600"></i>Edit Expense
                    </h2>
                    <button onclick="closeEditModal()" type="button" class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Form Content - Scrollable -->
            <form id="editExpenseForm" method="post" action="{{ url_for('fix_expense_update') }}" enctype="multipart/form-data">
                <div class="px-6 py-4 space-y-4 max-h-[60vh] overflow-y-auto">
                    
                    <!-- Hidden Fields -->
                    <input type="hidden" id="editExpenseId" name="expenseid" required>
                    <input type="hidden" id="deleteDocument" name="delete_document" value="false">
                    
                    <!-- Current Document Display with View & Delete -->
                    <div id="currentDocumentDisplay" class="hidden p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg">
                        <div class="flex items-start justify-between gap-3">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-file-alt text-blue-600 text-lg mr-2"></i>
                                    <span class="text-sm font-bold text-blue-800">Current Document</span>
                                </div>
                                <span id="currentDocumentName" class="text-sm text-gray-700 font-medium block break-all"></span>
                            </div>
                            <div class="flex flex-col gap-2">
                                <a id="currentDocumentLink" href="#" target="_blank" 
                                   class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-lg transition-colors whitespace-nowrap text-center">
                                    <i class="fas fa-eye mr-1"></i>View
                                </a>
                                <button type="button" onclick="deleteExpenseDocument()" 
                                        class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white text-xs font-medium rounded-lg transition-colors whitespace-nowrap">
                                    <i class="fas fa-trash mr-1"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Project Dropdown -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-project-diagram mr-1 text-gray-500"></i>Project
                        </label>
                        <select name="project" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
    <option value="">Keep current</option>
    <option value="non-project">non-project</option>
    {% for project in all_projects %}
    <option value="{{ project.project_name }}">{{ project.project_name }}</option>
    {% endfor %}
</select>

                    </div>

                    <!-- Category Dropdown -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tags mr-1 text-gray-500"></i>Category
                        </label>
                        <select id="editExpenseCategory" name="category" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Keep current</option>
                            <option value="Travel">Travel</option>
                            <option value="Equipment">Equipment</option>
                            <option value="Software">Software</option>
                            <option value="Training">Training</option>
                            <option value="Resources">Resources</option>
                            <option value="For email">For email</option>
                            <option value="Github">Github</option>
                            <option value="Api">Api</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <!-- Amount Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-rupee-sign mr-1 text-gray-500"></i>Amount
                        </label>
                        <input type="number" id="editExpenseAmount" name="amount" step="0.01" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="Enter amount">
                    </div>

                    <!-- Date Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar mr-1 text-gray-500"></i>Date
                        </label>
                        <input type="date" id="editExpenseDate" name="expdate" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Description Textarea -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-align-left mr-1 text-gray-500"></i>Description
                        </label>
                        <textarea id="editExpenseDescription" name="desc" rows="3" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none" 
                                  placeholder="Enter description"></textarea>
                    </div>

                    <!-- Upload New Document -->
                    <div class="pt-3 border-t border-gray-200">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-paperclip mr-1 text-gray-500"></i>Upload New Document (Optional)
                        </label>
                        <input type="file" name="expensedocument" id="editExpenseDocumentInput"
                               accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>Supported: PDF, JPG, PNG, Word, Excel. Max 10MB. Upload new file to replace existing.
                        </p>
                    </div>

                </div>

                <!-- Footer Buttons - Always Visible -->
                <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-xl">
                    <div class="flex space-x-3">
                        <button type="submit" 
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors shadow-md hover:shadow-lg">
                            <i class="fas fa-save mr-2"></i>Update Expense
                        </button>
                        <button type="button" onclick="closeEditModal()" 
                                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

            </div>







            <!-- Project Approvals Tab -->
            <div id="project-approvals" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-800">
                            <i class="fas fa-check-circle text-orange-600 mr-2"></i>Project Approvals
                        </h2>
                        <p class="text-sm text-gray-600 mt-1">Review and approve/reject project requests with budget allocation</p>
                    </div>
                    <div class="p-6">
                        {% if pending_projects %}
                            <div class="space-y-4">
                                {% for project in pending_projects %}
                                <div class="bg-gray-50 rounded-lg p-4 mb-4 border">
                                    <form method="post" action="{{ url_for('approve_project_hr_action') }}">
                                        <input type="hidden" name="project_id" value="{{ project.project_id }}">
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                                                <input type="text" name="project_name" value="{{ project.project_name }}" 
                                                    class="form-input w-full rounded-lg border-gray-300" required>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Budget (â‚¹)</label>
                                                <input type="number" name="budget_amount" step="0.01" value="{{ project.budget_amount }}" 
                                                    class="form-input w-full rounded-lg border-gray-300" required>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Cost Center</label>
                                                <input type="text" name="cost_center" value="{{ project.cost_center }}" 
                                                    class="form-input w-full rounded-lg border-gray-300" required>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                                <input type="date" name="end_date" value="{{ project.end_date }}" 
                                                    class="form-input w-full rounded-lg border-gray-300" required>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                            <textarea name="project_description" rows="2" 
                                                    class="form-textarea w-full rounded-lg border-gray-300" required>{{ project.description }}</textarea>
                                        </div>
                                        
                                        <div class="flex space-x-4">
                                            <button type="submit" 
                                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                                                <i class="fas fa-check mr-1"></i>Approve & Update
                                            </button>
                                            <button type="button" onclick="rejectProject('{{ project.project_id }}', '{{ project.project_name }}')" 
                                                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                                                <i class="fas fa-times mr-1"></i>Reject
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-8">
                                <i class="fas fa-check-circle text-3xl text-green-300 mb-3"></i>
                                <p class="text-gray-500">âœ… No pending project approvals</p>
                                <p class="text-sm text-gray-400 mt-2">All submitted projects have been reviewed.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

                    <!-- Project Rejection Modal -->
                    <div id="projectRejectionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">Reject Project</h3>
                                <button onclick="closeProjectRejectionModal()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <form method="post" action="{{ url_for('reject_project_hr_action') }}">
                                <input type="hidden" id="reject_project_id" name="project_id">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                                    <input type="text" id="reject_project_name" disabled 
                                        class="form-input w-full rounded-lg border-gray-300 bg-gray-100">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Rejection Reason</label>
                                    <textarea name="rejection_reason" rows="4" required
                                            class="form-textarea w-full rounded-lg border-gray-300"
                                            placeholder="Please provide reason for rejecting this project..."></textarea>
                                </div>
                                <div class="flex space-x-4">
                                    <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg">
                                        <i class="fas fa-times mr-1"></i>Reject Project
                                    </button>
                                    <button type="button" onclick="closeProjectRejectionModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
            <!-- Payroll Tab -->
            <div id="payroll" class="tab-content hidden">
                <div class="space-y-6">
                    <!-- Payroll Summary -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-calculator text-green-600 mr-2"></i>Payroll Summary
                            </h2>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="text-center p-4 bg-blue-50 rounded-lg">
                                    <h4 class="text-lg font-semibold text-blue-800">Total Employees</h4>
                                    <p class="text-2xl font-bold text-blue-600">{{ employee_salaries|length }}</p>
                                </div>
                                <div class="text-center p-4 bg-green-50 rounded-lg">
                                    <h4 class="text-lg font-semibold text-green-800">Monthly Payroll</h4>
                                    <p class="text-2xl font-bold text-green-600">â‚¹{{ "{:,.2f}".format(total_monthly_payroll|default(0)|float) }}</p>
                                </div>
                                <div class="text-center p-4 bg-purple-50 rounded-lg">
                                    <h4 class="text-lg font-semibold text-purple-800">Annual Payroll</h4>
                                    <p class="text-2xl font-bold text-purple-600">â‚¹{{ "{:,.2f}".format(total_annual_payroll|default(0)|float) }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-6">
        <label for="payrollEmployeeSearch" class="block text-sm font-medium text-gray-700 mb-2">
            Search Employee by Name
        </label>
        <input type="text" 
               id="payrollEmployeeSearch" 
               placeholder="Type employee name..." 
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
               onkeyup="filterPayrollTable()">
    </div>
                    <!-- Employee Salary Management -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-users text-blue-600 mr-2"></i>Employee Salary Management
                            </h2>
                            <p class="text-sm text-gray-600 mt-1">Salary increases will be deducted from remaining budget</p>
                        </div>
                        <div class="p-6">
                            {% if employee_salaries %}
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200" id="payrollSalariesTable">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monthly Salary (â‚¹)</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Yearly Salary (â‚¹)</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            {% for salary in employee_salaries %}
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                    <div class="flex items-center">
                                                        <div class="flex-shrink-0 h-8 w-8">
                                                            <div class="h-8 w-8 rounded-full bg-green-100 flex items-center justify-center">
                                                                <span class="text-xs font-medium text-green-600">{{ salary.username[0]|upper }}</span>
                                                            </div>
                                                        </div>
                                                        <div class="ml-3">
                                                            <div class="text-sm font-medium text-gray-900">{{ salary.username }}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ salary.name or 'N/A' }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ salary.role or 'N/A' }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">â‚¹{{ "{:,.2f}".format(salary.monthly_salary or 0) }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">â‚¹{{ "{:,.2f}".format(salary.yearly_salary or 0) }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                    <button class="text-blue-600 hover:text-blue-800 text-xs" 
                                                            onclick="editSalary('{{ salary.username }}', {{ salary.monthly_salary or 0 }}, {{ salary.yearly_salary or 0 }})">
                                                        <i class="fas fa-edit mr-1"></i>Edit
                                                    </button>
<button onclick="viewEmployeeDetails('{{ salary.username }}')" 
        class="text-green-600 hover:text-green-800 text-xs px-3 py-1.5 border border-green-200 rounded hover:bg-green-50 transition-colors">
  <i class="fas fa-eye mr-1"></i>View
</button>

                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-8">
                                    <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
                                    <p class="text-gray-500">No employee salary data found</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

<div id="employeeDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-xl w-full max-w-6xl max-h-[95vh] flex flex-col overflow-hidden shadow-2xl">

    <!-- Modal Header: fixed at top -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-4 flex justify-between items-center flex-shrink-0">
      <h3 class="text-xl font-bold text-white flex items-center">
        <i class="fas fa-user-circle mr-2"></i>Complete Employee Profile
      </h3>
      <button onclick="closeEmployeeDetailsModal()" 
              class="text-white hover:text-gray-200 transition-colors">
        <i class="fas fa-times text-2xl"></i>
      </button>
    </div>

    <!-- Fixed Employee Info Section (populated by JS) -->
    <div id="employeeBasicInfo" class="flex-shrink-0 bg-gradient-to-br from-blue-50 to-purple-50 px-6 py-4 border-b-2 border-blue-200"></div>

    <!-- Scrollable Content Area -->
    <div id="employeeDetailsContent" class="flex-1 overflow-y-auto p-6">
      <div class="flex items-center justify-center py-12">
        <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
        <p class="ml-4 text-gray-600">Loading employee details...</p>
      </div>
    </div>
  </div>
</div>


            <!-- Asset Approvals Tab -->
            <div id="asset-approvals" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-800">
                            <i class="fas fa-tools text-orange-600 mr-2"></i>Asset Requests from Johnny & Koyel
                        </h2>
                        <p class="text-sm text-gray-600 mt-1">Approve or reject asset requests. Approved amounts will be deducted from remaining budget.</p>
                    </div>
                    <div class="p-6">
                        {% if asset_requests %}
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset Type</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (â‚¹)</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">For Employee</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requested By</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>

                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        {% for asset in asset_requests %}
                                        <tr class="hover:bg-gray-50 {% if asset.status == 'Pending' %}bg-yellow-25{% endif %}">
                                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ asset.id }}</td>
                                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                <div class="flex items-center">
                                                    <i class="fas fa-laptop text-blue-500 mr-2"></i>
                                                    {{ asset.asset_type }}
                                                </div>
                                            </td>
                                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ asset.quantity }}</td>
                                            <td class="px-4 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">â‚¹{{ "{:,.2f}".format(asset.amount|default(0)|float) }}</td>
                                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ asset.for_employee or 'General' }}</td>
                                            <td class="px-4 py-4 text-sm text-gray-900 max-w-xs">
                                                <div class="truncate" title="{{ asset.description }}">{{ asset.description }}</div>
                                            </td>
                                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold bg-blue-100 text-blue-800 rounded-full">
                                                    <i class="fas fa-user mr-1"></i>{{ asset.requested_by }}
                                                </span>
                                            </td>
                                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ asset.requested_date }}</td>
                                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                                                {% if asset.status == 'Pending' %}
                                                    <span class="inline-flex px-2 py-1 text-xs font-semibold bg-yellow-100 text-yellow-800 rounded-full">
                                                        <i class="fas fa-clock mr-1"></i>Pending
                                                    </span>
                                                {% elif asset.status == 'Approved' %}
                                                    <span class="inline-flex px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded-full">
                                                        <i class="fas fa-check mr-1"></i>Approved
                                                    </span>
                                                {% elif asset.status == 'Rejected' %}
                                                    <span class="inline-flex px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded-full">
                                                        <i class="fas fa-times mr-1"></i>Rejected
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td class="px-4 py-4 whitespace-nowrap text-sm">
                                                {% if asset.document_path %}
                                                    <div class="flex space-x-2">
                                                        <a href="{{ url_for('view_asset_document', asset_id=asset.id) }}" 
                                                        target="_blank" 
                                                        class="text-blue-600 hover:text-blue-800 text-xs px-2 py-1 bg-blue-50 rounded-md border border-blue-200 hover:bg-blue-100 transition-colors">
                                                            <i class="fas fa-eye mr-1"></i>View
                                                        </a>
                                                        <a href="{{ url_for('download_asset_document', asset_id=asset.id) }}" 
                                                        class="text-green-600 hover:text-green-800 text-xs px-2 py-1 bg-green-50 rounded-md border border-green-200 hover:bg-green-100 transition-colors">
                                                            <i class="fas fa-download mr-1"></i>Download
                                                        </a>
                                                    </div>
                                                {% else %}
                                                    <span class="text-gray-400 text-xs">No document</span>
                                                {% endif %}
                                            </td>
                                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                {% if asset.status == 'Pending' %}
                                                  <form method="post" action="{{ url_for('approve_asset_request_hr') }}" style="display: inline;">
                                                        <input type="hidden" name="request_id" value="{{ asset.id }}">
                                                        <button type="submit" class="text-green-600 hover:text-green-800 text-xs"
                                                                onclick="return confirm('Approve asset request for â‚¹{{ "{:,.2f}".format(asset.amount|default(0)|float) }}? This amount will be deducted from remaining budget.')">
                                                            <i class="fas fa-check mr-1"></i>Approve
                                                        </button>
                                                    </form>
                                                    <button class="text-red-600 hover:text-red-800 text-xs"
                                                            onclick="rejectAssetRequest({{ asset.id }})">
                                                        <i class="fas fa-times mr-1"></i>Reject
                                                    </button>
                                                {% else %}
                                                    <span class="text-gray-400 text-xs">{{ asset.status }}</span>
                                                    {% if asset.rejection_reason %}
                                                        <div class="text-xs text-red-600 mt-1">{{ asset.rejection_reason }}</div>
                                                    {% endif %}
                                                {% endif %}
                                            </td>

                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4 text-sm text-gray-500">
                                <i class="fas fa-info-circle mr-1"></i>
                                Total pending asset cost: â‚¹{{ "{:,.2f}".format(asset_requests|selectattr("status", "equalto", "Pending")|list|safe_sum("amount")) }}
                            </div>
                        {% else %}
                            <div class="text-center py-8">
                                <i class="fas fa-tools text-4xl text-gray-300 mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-800 mb-2">No Asset Requests</h3>
                                <p class="text-gray-500">No asset requests have been submitted yet.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Team Approvals Tab -->
            <div id="team-approvals" class="tab-content hidden">
                <div class="space-y-6">
                    {% if has_team %}
                        <!-- Pending Work Approvals -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="px-6 py-4 border-b border-gray-200 bg-yellow-50">
                                <h2 class="text-lg font-semibold text-gray-800">
                                    <i class="fas fa-clock text-yellow-600 mr-2"></i>Pending Work Approvals
                                    <span class="ml-2 bg-yellow-100 text-yellow-600 text-sm px-2 py-1 rounded-full">
                                        {{ pending_team_work|length }}
                                    </span>
                                </h2>
                                <p class="text-sm text-gray-600 mt-1">Team members reporting to you need work approval</p>
                            </div>
                            <div class="p-6">
                                {% if pending_team_work %}
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hours</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Break Hours</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">
                                                {% for work in pending_team_work %}
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ work.username }}</td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ work.work_date }}</td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ work.project_name or '(non-project)' }}</td>
                                                    <td class="px-4 py-4 text-sm text-gray-900 max-w-xs">
                                                        <div class="truncate" title="{{ work.work_desc }}">{{ work.work_desc }}</div>
                                                    </td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ work.hours }}</td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ work.break_hours or 0 }}</td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                        <!-- Fix the team work approval forms -->
                                                        <form method="post" action="{{ url_for('approve_team_work_hr') }}" style="display: inline;">
                                                            <input type="hidden" name="work_id" value="{{ work.id }}">
                                                            <button type="submit" class="text-green-600 hover:text-green-800 text-xs">
                                                                <i class="fas fa-check mr-1"></i>Approve
                                                            </button>
                                                        </form>
                                                        </form>
                                                        <button class="text-red-600 hover:text-red-800 text-xs"
                                                                onclick="rejectTeamWork({{ work.id }})">
                                                            <i class="fas fa-times mr-1"></i>Reject
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="text-center py-6">
                                        <i class="fas fa-check-circle text-3xl text-green-300 mb-3"></i>
                                        <p class="text-gray-500">No pending work approvals</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Pending Leave Approvals -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="px-6 py-4 border-b border-gray-200 bg-blue-50">
                                <h2 class="text-lg font-semibold text-gray-800">
                                    <i class="fas fa-calendar-alt text-blue-600 mr-2"></i>Pending Leave Approvals
                                    <span class="ml-2 bg-blue-100 text-blue-600 text-sm px-2 py-1 rounded-full">
                                        {{ pending_team_leaves|length }}
                                    </span>
                                </h2>
                                <p class="text-sm text-gray-600 mt-1">Team members reporting to you need leave approval</p>
                            </div>
                            <div class="p-6">
                                {% if pending_team_leaves %}
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Leave Type</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document</th>

                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">
                                                {% for leave in pending_team_leaves %}
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ leave.username }}</td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold bg-blue-100 text-blue-800 rounded-full">
                                                            {{ leave.leave_type }}
                                                        </span>
                                                    </td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ leave.start_date }}</td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ leave.end_date }}</td>
                                                    <td class="px-4 py-4 text-sm text-gray-900 max-w-xs">
                                                        <div class="truncate" title="{{ leave.description }}">{{ leave.description }}</div>
                                                    </td>
                                                    <!-- In the pending team leaves table in hr_finance.html -->
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm">
                                                        {% if leave.health_document %}
                                                            <div class="flex space-x-2">
                                                                <a href="{{ url_for('view_leave_document', leave_id=leave.id) }}" 
                                                                target="_blank" 
                                                                class="text-blue-600 hover:text-blue-800 text-xs px-2 py-1 bg-blue-50 rounded-md border border-blue-200 hover:bg-blue-100 transition-colors">
                                                                    <i class="fas fa-eye mr-1"></i>View
                                                                </a>
                                                                <a href="{{ url_for('download_leave_document', leave_id=leave.id) }}" 
                                                                class="text-green-600 hover:text-green-800 text-xs px-2 py-1 bg-green-50 rounded-md border border-green-200 hover:bg-green-100 transition-colors">
                                                                    <i class="fas fa-download mr-1"></i>Download
                                                                </a>
                                                            </div>
                                                        {% else %}
                                                            <span class="text-gray-400 text-xs">No document</span>
                                                        {% endif %}
                                                    </td>

                                                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                        <!-- Fix the team leave approval forms -->
                                                        <form method="post" action="{{ url_for('approve_team_leave_hr') }}" style="display: inline;">
                                                            <input type="hidden" name="leave_id" value="{{ leave.id }}">
                                                            <button type="submit" class="text-green-600 hover:text-green-800 text-xs">
                                                                <i class="fas fa-check mr-1"></i>Approve
                                                            </button>
                                                        </form>
                                                        <button class="text-red-600 hover:text-red-800 text-xs"
                                                                onclick="rejectTeamLeave({{ leave.id }})">
                                                            <i class="fas fa-times mr-1"></i>Reject
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="text-center py-6">
                                        <i class="fas fa-check-circle text-3xl text-green-300 mb-3"></i>
                                        <p class="text-gray-500">No pending leave approvals</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="p-12 text-center">
                                <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-800 mb-2">No Team Members</h3>
                                <p class="text-gray-500">You don't have any team members reporting to you for approvals.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Employee Records Tab -->
            <div id="employee-records" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-800">
                            <i class="fas fa-history text-indigo-600 mr-2"></i>Employee Work & Leave Records
                        </h2>
                        <p class="text-sm text-gray-600 mt-1">View all employee timesheet and leave history with enhanced filtering</p>
                    </div>
                    
                    <!-- Sub-tabs for Work and Leave History -->
                    <div class="border-b border-gray-200">
                        <nav class="flex px-6" aria-label="Sub-tabs">
                            <button class="sub-tab-button active py-3 px-4 text-sm font-medium text-blue-600 border-b-2 border-blue-600" data-subtab="employee-work">
                                <i class="fas fa-clock mr-2"></i>Employee Work Records
                                <span class="ml-1 bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full">
                                    {{ employee_timesheets|length }}
                                </span>
                            </button>
                            <button class="sub-tab-button py-3 px-4 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300" data-subtab="employee-leaves">
                                <i class="fas fa-calendar-alt mr-2"></i>Employee Leave Records
                                <span class="ml-1 bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full">
                                    {{ employee_leaves|length }}
                                </span>
                            </button>
                        </nav>
                    </div>

                    <div class="p-6">
                        <!-- Employee Work Records Sub-tab -->
                        <div id="employee-work" class="sub-tab-content">
                            <div class="mb-4">
                                <h3 class="text-md font-semibold text-gray-800 mb-3">Enhanced Work Record Filters</h3>
                                <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                                    <input type="text" id="workEmpFilter" placeholder="Filter by employee..." 
                                           class="form-input rounded-lg border-gray-300" 
                                           onkeyup="filterTable('empWorkTable', 'workEmpFilter', 1)">
                                    <input type="text" id="workProjFilter" placeholder="Filter by project..." 
                                           class="form-input rounded-lg border-gray-300" 
                                           onkeyup="filterTable('empWorkTable', 'workProjFilter', 3)">
                                    <input type="date" id="workDateEmpFilter" placeholder="Filter by date..." 
                                           class="form-input rounded-lg border-gray-300" 
                                           onchange="filterTable('empWorkTable', 'workDateEmpFilter', 2)">
                                    <select id="workStatusEmpFilter" class="form-select rounded-lg border-gray-300" 
                                            onchange="filterTable('empWorkTable', 'workStatusEmpFilter', 7)">
                                        <option value="">All Statuses</option>
                                        <option value="approved">Approved</option>
                                        <option value="pending">Pending</option>
                                        <option value="rejected">Rejected</option>
                                    </select>
                                    <!-- NEW FILTERS -->
                                    <input type="text" id="workDescFilter" placeholder="Filter by description..." 
                                           class="form-input rounded-lg border-gray-300" 
                                           onkeyup="filterTable('empWorkTable', 'workDescFilter', 4)">
                                    <select id="workMonthFilter" class="form-select rounded-lg border-gray-300" 
                                            onchange="filterWorkByMonth()">
                                        <option value="">All Months</option>
                                        <option value="01">January</option>
                                        <option value="02">February</option>
                                        <option value="03">March</option>
                                        <option value="04">April</option>
                                        <option value="05">May</option>
                                        <option value="06">June</option>
                                        <option value="07">July</option>
                                        <option value="08">August</option>
                                        <option value="09">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                </div>
                            </div>
                            
                            {% if employee_timesheets %}
                                <div class="overflow-x-auto max-h-96 border rounded-lg">
                                    <table id="empWorkTable" class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Work Date</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hours</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Break Hours</th>
                                                 <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Overtime</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            {% for work in employee_timesheets %}
                                            <tr class="hover:bg-gray-50 transition-colors" data-month="{{ work.work_month|default(0)|zfill(2) }}">
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ work.id }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ work.username }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ work.work_date }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ work.project_name or '(non-project)' }}</td>
                                                <td class="px-4 py-4 text-sm text-gray-900 max-w-xs">
                                                    <div class="truncate" title="{{ work.work_desc }}">{{ work.work_desc }}</div>
                                                </td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ work.hours }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ work.break_hours or 0 }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                    {% set overtime_hours = (work.hours - 8) if work.hours > 8 else 0 %}
                    {% if overtime_hours > 0 %}
                        <span class="inline-flex px-2 py-1 text-xs font-semibold bg-orange-100 text-orange-800 rounded-full">
                            <i class="fas fa-clock mr-1"></i>{{ overtime_hours }}h OT
                        </span>
                    {% else %}
                        <span class="text-gray-400 text-xs">-</span>
                    {% endif %}
                </td>
                
                
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    {% set status = work.rm_status|lower if work.rm_status else '' %}
                                                    {% if status == 'approved' %}
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded-full">
                                                            <i class="fas fa-check mr-1"></i>Approved
                                                        </span>
                                                    {% elif status == 'pending' %}
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold bg-yellow-100 text-yellow-800 rounded-full">
                                                            <i class="fas fa-clock mr-1"></i>Pending
                                                        </span>
                                                    {% elif status == 'rejected' %}
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded-full">
                                                            <i class="fas fa-times mr-1"></i>Rejected
                                                        </span>
                                                    {% else %}
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold bg-gray-100 text-gray-800 rounded-full">
                                                            <i class="fas fa-question mr-1"></i>{{ work.rm_status|default('Unknown')|title }}
                                                        </span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-4 text-sm text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Showing {{ employee_timesheets|length }} work records from all employees
                                </div>
                            {% else %}
                                <div class="text-center py-12">
                                    <i class="fas fa-clock text-4xl text-gray-300 mb-4"></i>
                                    <h3 class="text-lg font-medium text-gray-800 mb-2">No Work Records Found</h3>
                                    <p class="text-gray-500">No employee timesheet records found.</p>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Employee Leave Records Sub-tab -->
                        <div id="employee-leaves" class="sub-tab-content hidden">
                            <div class="mb-4">
                                <h3 class="text-md font-semibold text-gray-800 mb-3">Enhanced Leave Record Filters</h3>
                                <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                                    <input type="text" id="leaveEmpFilter" placeholder="Filter by employee..." 
                                           class="form-input rounded-lg border-gray-300" 
                                           onkeyup="filterTable('empLeaveTable', 'leaveEmpFilter', 1)">
                                    <select id="leaveTypeEmpFilter" class="form-select rounded-lg border-gray-300" 
                                            onchange="filterTable('empLeaveTable', 'leaveTypeEmpFilter', 4)">
                                        <option value="">All Leave Types</option>
                                        <option value="Sick">Sick Leave</option>
                                        <option value="Vacation">Vacation</option>
                                        <option value="Personal">Personal Leave</option>
                                        <option value="Casual">Casual Leave</option>
                                        <option value="Other">Other</option>
                                    </select>
                                    <input type="date" id="leaveDateEmpFilter" placeholder="Filter by start date..." 
                                           class="form-input rounded-lg border-gray-300" 
                                           onchange="filterTable('empLeaveTable', 'leaveDateEmpFilter', 2)">
                                    <select id="leaveStatusEmpFilter" class="form-select rounded-lg border-gray-300" 
                                            onchange="filterTable('empLeaveTable', 'leaveStatusEmpFilter', 6)">
                                        <option value="">All Statuses</option>
                                        <option value="approved">Approved</option>
                                        <option value="pending">Pending</option>
                                        <option value="rejected">Rejected</option>
                                    </select>
                                    <!-- NEW FILTERS -->
                                    <input type="text" id="leaveDescFilter" placeholder="Filter by description..." 
                                           class="form-input rounded-lg border-gray-300" 
                                           onkeyup="filterTable('empLeaveTable', 'leaveDescFilter', 5)">
                                    <select id="leaveMonthFilter" class="form-select rounded-lg border-gray-300" 
                                            onchange="filterLeaveByMonth()">
                                        <option value="">All Months</option>
                                        <option value="01">January</option>
                                        <option value="02">February</option>
                                        <option value="03">March</option>
                                        <option value="04">April</option>
                                        <option value="05">May</option>
                                        <option value="06">June</option>
                                        <option value="07">July</option>
                                        <option value="08">August</option>
                                        <option value="09">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                </div>
                            </div>
                            
                            {% if employee_leaves %}
                                <div class="overflow-x-auto max-h-96 border rounded-lg">
                                    <table id="empLeaveTable" class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Leave Type</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            {% for leave in employee_leaves %}
                                            <tr class="hover:bg-gray-50 transition-colors" data-month="{{ leave.leave_month|default(0)|zfill(2) }}">
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ leave.id }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ leave.username }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ leave.start_date }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ leave.end_date }}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                                        {% if leave.leave_type == 'Sick' %}bg-green-100 text-green-800
                                                        {% elif leave.leave_type == 'Vacation' %}bg-blue-100 text-blue-800
                                                        {% elif leave.leave_type == 'Personal' %}bg-purple-100 text-purple-800
                                                        {% elif leave.leave_type == 'Casual' %}bg-yellow-100 text-yellow-800
                                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                        {% if leave.leave_type == 'Sick' %}<i class="fas fa-user-md mr-1"></i>
                                                        {% elif leave.leave_type == 'Vacation' %}<i class="fas fa-plane mr-1"></i>
                                                        {% elif leave.leave_type == 'Personal' %}<i class="fas fa-user mr-1"></i>
                                                        {% elif leave.leave_type == 'Casual' %}<i class="fas fa-coffee mr-1"></i>
                                                        {% else %}<i class="fas fa-question mr-1"></i>{% endif %}
                                                        {{ leave.leave_type }}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-4 text-sm text-gray-900 max-w-xs">
                                                    <div class="truncate" title="{{ leave.description }}">{{ leave.description }}</div>
                                                </td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    {% if leave.cancellation_requested and leave.cancellation_status == 'pending' %}
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold bg-orange-100 text-orange-800 rounded-full">
                                                            <i class="fas fa-exclamation mr-1"></i>Cancellation Pending
                                                        </span>
                                                    {% else %}
                                                        {% set status = leave.rm_status|lower if leave.rm_status else '' %}
                                                        {% if status == 'approved' %}
                                                            <span class="inline-flex px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded-full">
                                                                <i class="fas fa-check mr-1"></i>Approved
                                                            </span>
                                                        {% elif status == 'pending' %}
                                                            <span class="inline-flex px-2 py-1 text-xs font-semibold bg-yellow-100 text-yellow-800 rounded-full">
                                                                <i class="fas fa-clock mr-1"></i>Pending
                                                            </span>
                                                        {% elif status == 'rejected' %}
                                                            <span class="inline-flex px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded-full">
                                                                <i class="fas fa-times mr-1"></i>Rejected
                                                            </span>
                                                        {% else %}
                                                            <span class="inline-flex px-2 py-1 text-xs font-semibold bg-gray-100 text-gray-800 rounded-full">
                                                                <i class="fas fa-question mr-1"></i>{{ leave.rm_status|default('Unknown')|title }}
                                                            </span>
                                                        {% endif %}
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-4 text-sm text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Showing {{ employee_leaves|length }} leave records from all employees
                                </div>
                            {% else %}
                                <div class="text-center py-12">
                                    <i class="fas fa-calendar-alt text-4xl text-gray-300 mb-4"></i>
                                    <h3 class="text-lg font-medium text-gray-800 mb-2">No Leave Records Found</h3>
                                    <p class="text-gray-500">No employee leave records found.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- All Modals -->
<!-- Edit Budget Allocation Modal -->
<div id="editBudgetAllocationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Edit Budget Allocation</h3>
            <button onclick="closeEditAllocationModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form method="post" action="{{ url_for('edit_budget_allocation_action') }}">
            <input type="hidden" id="edit_project_name" name="project_name">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                <input type="text" id="edit_project_display" disabled 
                       class="form-input w-full rounded-lg border-gray-300 bg-gray-100">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Budget Amount (â‚¹)</label>
                <input type="number" id="edit_budget_amount" name="budget_amount" step="0.01" required 
                       class="form-input w-full rounded-lg border-gray-300">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Cost Center</label>
                <input type="text" id="edit_cost_center" name="cost_center" required
                       class="form-input w-full rounded-lg border-gray-300">
            </div>
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">
                    Update Allocation
                </button>
                <button type="button" onclick="closeEditAllocationModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Salary Modal -->
<div id="editSalaryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Edit Employee Salary</h3>
            <button onclick="closeSalaryModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mb-4 p-3 bg-orange-50 rounded-lg">
            <p class="text-sm text-orange-700">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                <strong>Note:</strong> Salary increases will be deducted from remaining budget automatically.
            </p>
        </div>
        <form method="post" action="{{ url_for('update_salary_action') }}">
            <input type="hidden" id="salary_username" name="username">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Employee</label>
                <input type="text" id="salary_username_display" disabled 
                       class="form-input w-full rounded-lg border-gray-300 bg-gray-100">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Monthly Salary (â‚¹)</label>
                <input type="number" id="salary_monthly" name="monthly_salary" step="0.01" required 
                       class="form-input w-full rounded-lg border-gray-300">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Yearly Salary (â‚¹)</label>
                <input type="number" id="salary_yearly" name="yearly_salary" step="0.01" 
                       class="form-input w-full rounded-lg border-gray-300"
                       readonly>
                <p class="text-xs text-gray-500 mt-1">Automatically calculated as Monthly Ã— 12</p>
            </div>
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">
                    <i class="fas fa-save mr-1"></i>Update Salary
                </button>
                <button type="button" onclick="closeSalaryModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Asset Rejection Modal -->
<div id="assetRejectionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Reject Asset Request</h3>
            <button onclick="closeAssetRejectionModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form method="post" action="{{ url_for('reject_asset_request_hr') }}">
            <input type="hidden" id="reject_asset_id" name="request_id">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Rejection Reason</label>
                <textarea name="rejection_reason" rows="4" required
                          class="form-textarea w-full rounded-lg border-gray-300"
                          placeholder="Please provide reason for rejecting this asset request..."></textarea>
            </div>
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg">
                    <i class="fas fa-times mr-1"></i>Reject Request
                </button>
                <button type="button" onclick="closeAssetRejectionModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Team Work Rejection Modal -->
<div id="teamWorkRejectionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Reject Team Work</h3>
            <button onclick="closeTeamWorkRejectionModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form method="post" action="{{ url_for('reject_team_work') }}">
            <input type="hidden" id="reject_work_id" name="timesheet_id">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Rejection Reason</label>
                <textarea name="rejection_reason" rows="4" required
                          class="form-textarea w-full rounded-lg border-gray-300"
                          placeholder="Please provide reason for rejecting this work entry..."></textarea>
            </div>
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg">
                    <i class="fas fa-times mr-1"></i>Reject Work
                </button>
                <button type="button" onclick="closeTeamWorkRejectionModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Team Leave Rejection Modal -->
<div id="teamLeaveRejectionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Reject Team Leave</h3>
            <button onclick="closeTeamLeaveRejectionModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form method="post" action="{{ url_for('reject_team_leave') }}">
            <input type="hidden" id="reject_leave_id" name="leave_id">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Rejection Reason</label>
                <textarea name="rejection_reason" rows="4" required
                          class="form-textarea w-full rounded-lg border-gray-300"
                          placeholder="Please provide reason for rejecting this leave request..."></textarea>
            </div>
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg">
                    <i class="fas fa-times mr-1"></i>Reject Leave
                </button>
                <button type="button" onclick="closeTeamLeaveRejectionModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Project Modal -->
<div id="editProjectModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Edit Project</h3>
            <button onclick="closeEditProjectModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form method="post" action="{{ url_for('edit_project_hr') }}">
            <input type="hidden" id="edit_project_name_field" name="project_name">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                <input type="text" id="edit_project_name_display" disabled 
                       class="form-input w-full rounded-lg border-gray-300 bg-gray-100">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Cost Center</label>
                <input type="text" id="edit_project_cost_center" name="cost_center" required
                       class="form-input w-full rounded-lg border-gray-300">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <textarea id="edit_project_description" name="description" rows="3" required
                          class="form-textarea w-full rounded-lg border-gray-300"></textarea>
            </div>
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">
                    Update Project
                </button>
                <button type="button" onclick="closeEditProjectModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>
<!-- ====================================================================== -->

        <!-- ====================================================================== -->
<!-- WORK ASSIGNMENTS TAB - SIMPLE LIKE MANAGER VIEW -->
<!-- ====================================================================== -->

<div id="work-assignments" class="tab-content hidden">
    <div class="bg-white rounded-xl shadow-lg p-6">
        
        <!-- Simple Header with Button -->
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-tasks text-blue-600 mr-3"></i>
                All Employee Work Status
            </h2>
            <button onclick="openHRAssignWorkModal()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold">
                <i class="fas fa-plus mr-2"></i>Assign Work
            </button>
        </div>

        <!-- Work Assignments Table -->
        {% if work_assignments and work_assignments|length > 0 %}
        <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">ID</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Employee</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Assigned By</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Project</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Task</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Jira Status</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Employee Status</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Timeline</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for work in work_assignments %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-4 text-sm font-bold">#{{ work.id }}</td>
                        
                        <td class="px-4 py-4">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-semibold text-xs mr-2">
                                    {{ work.assigned_to[0]|upper }}
                                </div>
                                <span class="text-sm font-medium">{{ work.assigned_to }}</span>
                            </div>
                        </td>
                        
                        <td class="px-4 py-4 text-sm">{{ work.assigned_by }}</td>
                        
                        <td class="px-4 py-4">
                            <span class="px-2 py-1 text-xs font-medium rounded bg-purple-100 text-purple-800">
                                {{ work.project_name or '(non-project)' }}
                            </span>
                        </td>
                        
                        <td class="px-4 py-4 max-w-xs">
                            <div class="text-sm text-gray-700 truncate">
                                {{ work.task_desc[:50] }}{% if work.task_desc|length > 50 %}...{% endif %}
                            </div>
                        </td>
                        
                        <td class="px-4 py-4">
                            {% if work.jira_issue_key %}
                            <a href="https://sai8903.atlassian.net/browse/{{ work.jira_issue_key }}" target="_blank"
                               class="px-2 py-1 text-xs font-semibold rounded inline-flex items-center hover:opacity-80"
                               style="background-color: #{{ work.jira_status_color or '6B7280' }}20; color: #{{ work.jira_status_color or '6B7280' }};">
                                <i class="fab fa-jira mr-1"></i>{{ work.jira_status or 'To Do' }}
                            </a>
                            {% else %}
                            <span class="text-gray-400 text-xs">No Jira</span>
                            {% endif %}
                        </td>
                        
                        <td class="px-4 py-4">
                            {% if work.employee_status %}
                            <span class="px-2 py-1 text-xs font-semibold rounded
                                {% if work.employee_status == 'Completed' %}bg-green-100 text-green-800
                                {% elif work.employee_status == 'In Progress' %}bg-blue-100 text-blue-800
                                {% elif work.employee_status == 'Blocked' %}bg-red-100 text-red-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ work.employee_status }}
                            </span>
                            {% else %}
                            <span class="text-gray-400 text-xs">Not Updated</span>
                            {% endif %}
                        </td>
                        
                        <td class="px-4 py-4 text-xs text-gray-600">
                            <div>Start: {{ work.start_date or 'N/A' }}</div>
                            <div>Due: {{ work.due_date or 'No deadline' }}</div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-12 bg-gray-50 rounded-lg">
            <i class="fas fa-tasks text-gray-400 text-5xl mb-4"></i>
            <p class="text-gray-500">No work assignments yet.</p>
        </div>
        {% endif %}
    </div>
</div>





<!-- JavaScript for Complete Dashboard Functionality -->






<!-- ====================================================================== -->
<!-- SIMPLE ASSIGN WORK MODAL -->
<!-- ====================================================================== -->

<script>
function openHRAssignWorkModal() {
    const modal = document.createElement('div');
    modal.id = 'hrAssignWorkModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="p-5 border-b flex items-center justify-between">
                <h3 class="text-xl font-bold">Assign Work to Employees</h3>
                <button onclick="closeHRAssignWorkModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="overflow-y-auto p-5">
                <form method="post" action="/hr_assign_work_action" id="assignWorkForm">
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2">Employees *</label>
                        <select name="employees" multiple required size="6"
                                class="w-full px-3 py-2 border rounded">
                            {% for emp in all_employees_list %}
                            <option value="{{ emp.username }}">{{ emp.name or emp.username }} - {{ emp.role }}</option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple</p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2">Project (Optional)</label>
                        <select name="projectname" class="w-full px-3 py-2 border rounded">
                            <option value="">-- No Project --</option>
                            {% for proj in all_projects %}
                            <option value="{{ proj.project_name }}">{{ proj.project_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2">Task Description *</label>
                        <textarea name="taskdesc" required rows="4" 
                                  class="w-full px-3 py-2 border rounded"
                                  placeholder="Describe the task..."></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold mb-2">Start Date</label>
                            <input type="date" name="startdate" value="{{ today }}" class="w-full px-3 py-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">Due Date</label>
                            <input type="date" name="duedate" class="w-full px-3 py-2 border rounded">
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="p-5 border-t flex gap-3">
                <button type="submit" form="assignWorkForm"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-semibold">
                    Assign & Create Jira
                </button>
                <button onclick="closeHRAssignWorkModal()" 
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 rounded font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function closeHRAssignWorkModal() {
    const modal = document.getElementById('hrAssignWorkModal');
    if (modal) modal.remove();
}

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeHRAssignWorkModal();
});









// Sync Jira status
async function syncWorkJiraStatus(workId) {
    if (!confirm('Sync Jira status for this work assignment?')) return;
    
    const button = event.target.closest('button');
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    try {
        const response = await fetch(`/syncjirastatus/${workId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… Jira status synced successfully!');
            location.reload();
        } else {
            alert('âŒ Error: ' + result.error);
            button.innerHTML = '<i class="fas fa-sync-alt"></i>';
            button.disabled = false;
        }
    } catch (error) {
        alert('âŒ Error syncing Jira status: ' + error);
        button.innerHTML = '<i class="fas fa-sync-alt"></i>';
        button.disabled = false;
    }
}

// Show full task description
function showFullTask(task) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full p-6">
            <div class="flex items-center justify-between mb-4 pb-4 border-b">
                <h3 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-file-alt text-blue-600 mr-2"></i>Full Task Description
                </h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 p-2">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="bg-gray-50 rounded-xl p-5 max-h-96 overflow-y-auto">
                <p class="text-gray-700 whitespace-pre-wrap leading-relaxed">${task}</p>
            </div>
            <div class="mt-5 flex justify-end">
                <button onclick="this.closest('.fixed').remove()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold shadow-md">
                    Close
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Show progress notes
function showWorkProgressNotes(employeeName, notes) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full p-6">
            <div class="flex items-center justify-between mb-4 pb-4 border-b">
                <h3 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-comment-dots text-blue-600 mr-2"></i>
                    Progress Notes from ${employeeName}
                </h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 p-2">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-5 max-h-96 overflow-y-auto border-l-4 border-blue-500">
                <p class="text-gray-700 whitespace-pre-wrap leading-relaxed">${notes || 'No progress notes available.'}</p>
            </div>
            <div class="mt-5 flex justify-end">
                <button onclick="this.closest('.fixed').remove()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold shadow-md">
                    Close
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// View work details
function viewWorkDetails(workId) {
    // Implement detailed view if needed
    alert('Work details view - ID: ' + workId);
}

// Close modals on ESC key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeHRAssignWorkModal();
        const modals = document.querySelectorAll('.fixed.inset-0');
        modals.forEach(modal => modal.remove());
    }
});

// Edit Expense Function
function editExpense(id, project, category, amount, date, description, documentPath) {
    console.log('EDITING EXPENSE:', id, 'Document:', documentPath);
    
    // Set form fields
    document.getElementById('editExpenseId').value = id;
    document.querySelector('select[name="project"]').value = project || '';
    document.getElementById('editExpenseCategory').value = category || '';
    document.getElementById('editExpenseAmount').value = amount || '';
    document.getElementById('editExpenseDate').value = date || '';
    document.getElementById('editExpenseDescription').value = description || '';
    
    // Reset delete document flag
    document.getElementById('deleteDocument').value = 'false';
    
    // Show/hide current document
    const docDisplay = document.getElementById('currentDocumentDisplay');
    const docName = document.getElementById('currentDocumentName');
    const docLink = document.getElementById('currentDocumentLink');
    
    if (documentPath && documentPath !== 'None' && documentPath !== 'null' && documentPath.trim() !== '') {
        const filename = documentPath.split('/').pop() || 'Document';
        docName.textContent = filename;
        docLink.href = `/view_expense_document?expenseid=${id}`;
        docDisplay.classList.remove('hidden');
        console.log('Document shown:', filename);
    } else {
        docDisplay.classList.add('hidden');
        console.log('No document to show');
    }
    
    // Show modal
    document.getElementById('editExpenseModal').classList.remove('hidden');
}

// Close Modal Function
function closeEditModal() {
    document.getElementById('editExpenseModal').classList.add('hidden');
    // Reset form
    document.getElementById('editExpenseForm').reset();
    document.getElementById('deleteDocument').value = 'false';
    document.getElementById('currentDocumentDisplay').classList.add('hidden');
}

// Delete Document Function
function deleteExpenseDocument() {
    if (confirm('âš ï¸ Are you sure you want to delete this document?\n\nThis action cannot be undone. The document will be permanently removed when you update the expense.')) {
        // Set hidden field to indicate document should be deleted
        document.getElementById('deleteDocument').value = 'true';
        
        // Hide the current document display
        document.getElementById('currentDocumentDisplay').classList.add('hidden');
        
        // Show success message
        alert('âœ… Document marked for deletion. Click "Update Expense" to confirm.');
    }
}







// Function to close the modal
function closeEditModal() {
    const modal = document.getElementById('editExpenseModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Optional: Add form validation before submit
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('editExpenseForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const expenseId = document.getElementById('editExpenseId').value;
            console.log('Form submitting with expense ID:', expenseId);
            
            if (!expenseId) {
                e.preventDefault();
                alert('Error: No expense ID found. Please try again.');
                return false;
            }
        });
    }
});


// Delete expense function
function deleteExpense(expenseId, description) {
    if (confirm(`Are you sure you want to delete this expense?\n\n"${description}"\n\nThis action cannot be undone.`)) {
        // Create a form to submit the deletion
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("delete_expense_action") }}';
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'expense_id';
        input.value = expenseId;
        
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}

// Enhanced expense table functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add keyboard shortcut for editing (when row is focused)
    const expenseRows = document.querySelectorAll('#expenseTable tbody tr');
    expenseRows.forEach(row => {
        row.addEventListener('dblclick', function() {
            const editButton = this.querySelector('button[onclick*="editExpense"]');
            if (editButton) {
                editButton.click();
            }
        });
    });
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeEditExpenseModal();
        }
    });
});

document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.getAttribute('data-tab');
            
            // Update button styles
            tabButtons.forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-blue-600');
                btn.classList.add('text-gray-500', 'border-transparent');
            });
            
            button.classList.add('text-blue-600', 'border-blue-600');
            button.classList.remove('text-gray-500', 'border-transparent');
            
            // Update content visibility
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(tabId).classList.remove('hidden');
        });
    });

    // Sub-tabs functionality
    const subTabButtons = document.querySelectorAll('.sub-tab-button');
    const subTabContents = document.querySelectorAll('.sub-tab-content');
    
    subTabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const subTabId = button.getAttribute('data-subtab');
            
            // Update sub-tab button styles
            subTabButtons.forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-blue-600');
                btn.classList.add('text-gray-500', 'border-transparent');
            });
            
            button.classList.add('text-blue-600', 'border-blue-600');
            button.classList.remove('text-gray-500', 'border-transparent');
            
            // Update sub-tab content visibility
            subTabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(subTabId).classList.remove('hidden');
        });
    });

    // Auto-calculate yearly salary when monthly is changed
    const monthlyInput = document.getElementById('salary_monthly');
    const yearlyInput = document.getElementById('salary_yearly');
    
    if (monthlyInput && yearlyInput) {
        monthlyInput.addEventListener('input', function() {
            const monthly = parseFloat(this.value) || 0;
            yearlyInput.value = (monthly * 12).toFixed(2);
        });
    }

    // Auto-refresh after budget operations
    const flashMessages = document.querySelectorAll('.bg-blue-100');
    flashMessages.forEach(message => {
        if (message.textContent.includes('allocated from remaining budget') || 
            message.textContent.includes('Salary updated') ||
            message.textContent.includes('Asset request approved')) {
            
            console.log('Budget operation detected, refreshing page in 2 seconds...');
            
            setTimeout(() => {
                window.location.reload(true);
            }, 2000);
        }
    });
});

// Enhanced filter function for multiple criteria
function filterTable(tableId, inputId, columnIndex) {
    const input = document.getElementById(inputId);
    const filter = input.value.toUpperCase();
    const table = document.getElementById(tableId);
    const tr = table.getElementsByTagName('tr');
    
    for (let i = 1; i < tr.length; i++) {
        const td = tr[i].getElementsByTagName('td')[columnIndex];
        if (td) {
            const textValue = td.textContent || td.innerText;
            if (textValue.toUpperCase().indexOf(filter) > -1) {
                tr[i].style.display = "";
            } else {
                tr[i].style.display = "none";
            }
        }
    }
}

// Month filtering for work records
function filterWorkByMonth() {
    const monthFilter = document.getElementById('workMonthFilter').value;
    const table = document.getElementById('empWorkTable');
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const monthData = row.getAttribute('data-month');
        
        if (!monthFilter || monthData === monthFilter) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    }
}

// Month filtering for leave records
function filterLeaveByMonth() {
    const monthFilter = document.getElementById('leaveMonthFilter').value;
    const table = document.getElementById('empLeaveTable');
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const monthData = row.getAttribute('data-month');
        
        if (!monthFilter || monthData === monthFilter) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    }
}

// Budget Usage Modal Functions (UPDATED)
function showBudgetUsageDetails() {
    document.getElementById('budgetUsageModal').classList.remove('hidden');
    
    fetch('/budget_usage_details')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayBudgetUsageDetails(data.usage_details);
            } else {
                document.getElementById('budgetUsageContent').innerHTML = 
                    '<div class="text-center py-4"><p class="text-red-500">Error loading budget details: ' + data.error + '</p></div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('budgetUsageContent').innerHTML = 
                '<div class="text-center py-4"><p class="text-red-500">Error loading budget details</p></div>';
        });
}

// Function to display budget usage details in table
function displayBudgetUsageDetails(details) {
    let html = '';
    
    if (details.length === 0) {
        html = '<div class="text-center py-4"><p class="text-gray-500">No budget usage details found.</p></div>';
    } else {
        html = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Project</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Created By</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
        `;
        
        details.forEach(detail => {
            html += `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 text-sm text-gray-900">â‚¹{detail.project_name}</td>
                    <td class="px-4 py-2 text-sm">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                            â‚¹{detail.usage_type === 'Salary Increase' ? 'bg-yellow-100 text-yellow-800' : 
                              detail.usage_type === 'Asset Purchase' ? 'bg-purple-100 text-purple-800' : 
                              'bg-blue-100 text-blue-800'}">
                            â‚¹{detail.usage_type}
                        </span>
                    </td>
                    <td class="px-4 py-2 text-sm font-medium text-gray-900">â‚¹â‚¹{parseFloat(detail.amount || 0).toLocaleString()}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">â‚¹{detail.created_by}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">â‚¹{new Date(detail.created_on).toLocaleDateString()}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
    }
    
    document.getElementById('budgetUsageContent').innerHTML = html;
}

function closeBudgetUsageModal() {
    document.getElementById('budgetUsageModal').classList.add('hidden');
}

// Budget table filtering function
function filterBudgetTable() {
    var input, filter, table, tr, td, i, j, txtValue, visible;
    input = document.getElementById("budgetFilter");
    if (!input) return;
    
    filter = input.value.toUpperCase();
    table = document.querySelector("#budgetUsageModal table");
    if (!table) return;
    
    tr = table.getElementsByTagName("tr");
    
    for (i = 1; i < tr.length; i++) { // Skip header row
        tr[i].style.display = "none";
        td = tr[i].getElementsByTagName("td");
        visible = false;
        
        // Check all columns for the filter text
        for (j = 0; j < td.length; j++) {
            if (td[j]) {
                txtValue = td[j].textContent || td[j].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    visible = true;
                    break;
                }
            }
        }
        
        if (visible) {
            tr[i].style.display = "";
        }
    }
}

// Budget modal functions
function editTotalBudget() {
    const modal = document.getElementById('editBudgetModal');
    const budgetInput = modal.querySelector('input[name="total_budget"]');
    
    const currentBudgetText = document.getElementById('totalBudgetDisplay').textContent;
    const currentBudget = currentBudgetText.replace(/[â‚¹,]/g, '');
    
    budgetInput.value = currentBudget;
    modal.classList.remove('hidden');
}

function closeBudgetModal() {
    document.getElementById('editBudgetModal').classList.add('hidden');
}

function editSalary(username, monthlyAmount, yearlyAmount) {
    document.getElementById('salary_username').value = username;
    document.getElementById('salary_username_display').value = username;
    document.getElementById('salary_monthly').value = monthlyAmount;
    document.getElementById('salary_yearly').value = yearlyAmount;
    document.getElementById('editSalaryModal').classList.remove('hidden');
}

function closeSalaryModal() {
    document.getElementById('editSalaryModal').classList.add('hidden');
}

// Asset approval functions
function rejectAssetRequest(requestId) {
    document.getElementById('reject_asset_id').value = requestId;
    document.getElementById('assetRejectionModal').classList.remove('hidden');
}

function closeAssetRejectionModal() {
    document.getElementById('assetRejectionModal').classList.add('hidden');
}

// Team approval functions
function rejectTeamWork(workId) {
    document.getElementById('reject_work_id').value = workId;
    document.getElementById('teamWorkRejectionModal').classList.remove('hidden');
}

function closeTeamWorkRejectionModal() {
    document.getElementById('teamWorkRejectionModal').classList.add('hidden');
}

function rejectTeamLeave(leaveId) {
    document.getElementById('reject_leave_id').value = leaveId;
    document.getElementById('teamLeaveRejectionModal').classList.remove('hidden');
}

function closeTeamLeaveRejectionModal() {
    document.getElementById('teamLeaveRejectionModal').classList.add('hidden');
}

// Project management functions
function editProject(projectName, costCenter, description) {
    document.getElementById('edit_project_name_field').value = projectName;
    document.getElementById('edit_project_name_display').value = projectName;
    document.getElementById('edit_project_cost_center').value = costCenter || '';
    document.getElementById('edit_project_description').value = description || '';
    document.getElementById('editProjectModal').classList.remove('hidden');
}

function closeEditProjectModal() {
    document.getElementById('editProjectModal').classList.add('hidden');
}
function rejectProject(projectId, projectName) {
    document.getElementById('reject_project_id').value = projectId;
    document.getElementById('reject_project_name').value = projectName;
    document.getElementById('projectRejectionModal').classList.remove('hidden');
}

function closeProjectRejectionModal() {
    document.getElementById('projectRejectionModal').classList.add('hidden');
}
// Budget allocation functions
function editBudgetAllocation(projectName, budgetAmount, costCenter) {
    document.getElementById('edit_project_name').value = projectName;
    document.getElementById('edit_project_display').value = projectName;
    document.getElementById('edit_budget_amount').value = budgetAmount;
    document.getElementById('edit_cost_center').value = costCenter || '';
    document.getElementById('editBudgetAllocationModal').classList.remove('hidden');
}

function closeEditAllocationModal() {
    document.getElementById('editBudgetAllocationModal').classList.add('hidden');
}

function removeBudgetAllocation(projectName) {
    if (confirm(`Are you sure you want to remove budget allocation for "â‚¹{projectName}"?`)) {
        // Create a form to submit the removal
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("remove_budget_allocation_action") }}';
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'project_name';
        input.value = projectName;
        
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}
function refreshPendingProjects() {
    fetch('/get_pending_approvals')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Pending projects:', data.pending_projects);
                // Update the pending projects display
                location.reload(); // Simple refresh for now
            }
        });
}

// Quick action functions
function downloadFinancialReport() {
    alert('Financial report download functionality will be implemented.');
}

function exportBudgetData() {
    alert('Budget data export functionality will be implemented.');
}

function generatePayrollReport() {
    alert('Payroll report generation functionality will be implemented.');
}

function generatePayslip(username) {
    alert(`Payslip generation for â‚¹{username} will be implemented.`);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Escape to close modals
    if (e.key === 'Escape') {
        const modals = [
            'editBudgetModal',
            'editSalaryModal',
            'assetRejectionModal',
            'teamWorkRejectionModal',
            'teamLeaveRejectionModal',
            'budgetUsageModal',
            'editProjectModal',
            'editBudgetAllocationModal'
        ];
        
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal && !modal.classList.contains('hidden')) {
                modal.classList.add('hidden');
            }
        });
    }
});
// Work sub-tabs functionality
const workSubTabButtons = document.querySelectorAll('.work-sub-tab-button');
const workSubTabContents = document.querySelectorAll('.work-sub-tab-content');

workSubTabButtons.forEach(button => {
    button.addEventListener('click', () => {
        const subTabId = button.getAttribute('data-subtab');
        
        // Update work sub-tab button styles
        workSubTabButtons.forEach(btn => {
            btn.classList.remove('text-blue-600', 'border-blue-600');
            btn.classList.add('text-gray-500', 'border-transparent');
        });
        
        button.classList.add('text-blue-600', 'border-blue-600');
        button.classList.remove('text-gray-500', 'border-transparent');
        
        // Update work sub-tab content visibility
        workSubTabContents.forEach(content => {
            content.classList.add('hidden');
        });
        
        document.getElementById(subTabId).classList.remove('hidden');
    });
});

// Employee details filtering function
function filterEmployeeDetails() {
    const nameFilter = document.getElementById('empDetailFilter').value.toLowerCase();
    const roleFilter = document.getElementById('empRoleFilter').value.toLowerCase();
    const statusFilter = document.getElementById('empStatusFilter').value.toLowerCase();
    const typeFilter = document.getElementById('empTypeFilter').value.toLowerCase();
    
    const rows = document.querySelectorAll('.employee-row');
    
    rows.forEach(row => {
        const name = row.getAttribute('data-name') || '';
        const username = row.getAttribute('data-username') || '';
        const role = row.getAttribute('data-role') || '';
        const status = row.getAttribute('data-status') || '';
        const empType = row.getAttribute('data-employment-type') || '';
        
        const nameMatch = !nameFilter || name.includes(nameFilter) || username.includes(nameFilter);
        const roleMatch = !roleFilter || role.includes(roleFilter);
        const statusMatch = !statusFilter || status.includes(statusFilter);
        const typeMatch = !typeFilter || empType.includes(typeFilter);
        
        if (nameMatch && roleMatch && statusMatch && typeMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// View employee profile function
function viewEmployeeProfile(username) {
    // Create a modal or redirect to detailed view
    alert(`View full profile for ${username} - This functionality can be expanded`);
}

// Edit employee salary function (reuse existing function)
function editEmployeeSalary(username, monthlyAmount, yearlyAmount) {
    editSalary(username, monthlyAmount, yearlyAmount);
}

// View employee reports function
function viewEmployeeReports(username) {
    alert(`View work reports for ${username} - This functionality can be expanded`);
}

// Export employee data function
function exportEmployeeData() {
    alert('Employee data export functionality will be implemented');
}
// ==================== OTHER CATEGORY FUNCTIONALITY ====================

function toggleOtherCategoryField() {
    const categorySelect = document.getElementById('expense-category-select');
    const otherField = document.getElementById('other-category-field');
    const otherInput = document.getElementById('other-category-input');
    
    if (categorySelect.value === 'Other') {
        // Show the "Other" category field
        otherField.classList.remove('hidden');
        otherInput.setAttribute('required', 'required');
        otherInput.focus(); // Focus on the input for better UX
    } else {
        // Hide the "Other" category field
        otherField.classList.add('hidden');
        otherInput.removeAttribute('required');
        otherInput.value = ''; // Clear the input
    }
}

// Enhanced filter function to handle custom categories
function filterTable(tableId, inputId, columnIndex) {
    const input = document.getElementById(inputId);
    const filter = input.value.toLowerCase();
    const table = document.getElementById(tableId);
    const tr = table.getElementsByTagName('tr');
    
    for (let i = 1; i < tr.length; i++) { // Skip header row
        const td = tr[i].getElementsByTagName('td')[columnIndex];
        if (td) {
            const textValue = td.textContent || td.innerText;
            const categoryText = textValue.toLowerCase();
            
            // Special handling for "Other Categories" filter
            if (filter === 'other') {
                // Show rows that don't match standard categories
                const isStandardCategory = [
                    'travel', 'equipment', 'software', 'training', 
                    'resources', 'for email', 'github', 'api'
                ].some(cat => categoryText.includes(cat.toLowerCase()));
                
                tr[i].style.display = !isStandardCategory ? '' : 'none';
            } else if (filter === '') {
                // Show all when no filter
                tr[i].style.display = '';
            } else {
                // Normal filtering
                tr[i].style.display = categoryText.includes(filter) ? '' : 'none';
            }
        }
    }
}

// Auto-populate category filter with existing custom categories
function populateCategoryFilter() {
    const table = document.getElementById('expenseTable');
    if (!table) return;
    
    const categoryFilter = document.getElementById('expenseCategoryFilter');
    const existingCategories = new Set();
    const standardCategories = [
        'travel', 'equipment', 'software', 'training', 
        'resources', 'for email', 'github', 'api'
    ];
    
    // Get all categories from the table
    const rows = table.getElementsByTagName('tr');
    for (let i = 1; i < rows.length; i++) {
        const categoryCell = rows[i].getElementsByTagName('td')[3]; // Category column
        if (categoryCell) {
            const category = categoryCell.textContent.trim().toLowerCase();
            if (!standardCategories.includes(category)) {
                existingCategories.add(category);
            }
        }
    }
    
    // Add custom categories to filter dropdown
    existingCategories.forEach(category => {
        if (![...categoryFilter.options].some(option => option.value === category)) {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
            categoryFilter.appendChild(option);
        }
    });
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Populate category filter with existing custom categories
    populateCategoryFilter();
    
    // Add form validation
    const expenseForm = document.querySelector('form[action*="hrrecordexpenseaction"]');
    if (expenseForm) {
        expenseForm.addEventListener('submit', function(e) {
            const categorySelect = document.getElementById('expense-category-select');
            const otherInput = document.getElementById('other-category-input');
            
            if (categorySelect.value === 'Other' && !otherInput.value.trim()) {
                e.preventDefault();
                alert('Please specify the other category when selecting "Other".');
                otherInput.focus();
                return false;
            }
        });
    }
});

function viewEmployeeDetails(username) {
    // Open modal
    const modal = document.getElementById('employeeDetailsModal');
    if (!modal) {
        alert('Modal element not found!');
        return;
    }
    modal.classList.remove('hidden');
    document.getElementById('employeeBasicInfo').innerHTML = 
        '<div class="flex items-center justify-center py-4">' +
        '<i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>' +
        '<p class="ml-3 text-gray-600">Loading...</p></div>';
    document.getElementById('employeeDetailsContent').innerHTML = 
        '<div class="flex items-center justify-center py-12">' +
        '<i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>' +
        '<p class="ml-4 text-gray-600">Loading employee details...</p></div>';

    fetch('/api/employee-details/' + encodeURIComponent(username))
      .then(res => res.ok ? res.json() : res.json().then(d => {throw new Error(d.error)}))
      .then(data => {
        const emp = data.employee || {};
        const documents = data.documents || [];
        const safe = t => t && t !== 'null' && t !== 'None' ? t : 'N/A';
        // PHOTO BLOCK
        const photoHtml =
          emp.photourl && emp.photourl !== '' && emp.photourl !== 'None'
            ? `<img src="/view-employee-photo/${encodeURIComponent(emp.username)}"
                   alt="${safe(emp.name)}"
                   class="w-24 h-24 rounded-full object-cover border-4 border-white shadow-lg"
                   onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
               <div style="display:none;" class="w-24 h-24 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-3xl font-bold border-4 border-white shadow-lg">
                 ${safe(emp.username?emp.username[0].toUpperCase():'?')}
               </div>`
            : `<div class="w-24 h-24 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-3xl font-bold border-4 border-white shadow-lg">
                 ${safe(emp.username?emp.username[0].toUpperCase():'?')}
               </div>`;

        document.getElementById('employeeBasicInfo').innerHTML =
          `<div class="flex items-center space-x-4">
            <div class="flex-shrink-0">
              ${photoHtml}
            </div>
            <div class="flex-1">
              <h2 class="text-2xl font-bold text-gray-900">${safe(emp.name)}</h2>
              <p class="text-md text-gray-600 mb-2">@${safe(emp.username)}</p>
              <div class="flex flex-wrap gap-2">
                <span class="inline-flex px-3 py-1 text-xs font-semibold bg-blue-100 text-blue-800 rounded-full">
                  <i class="fas fa-briefcase mr-1"></i>${safe(emp.role)}
                </span>
                <span class="inline-flex px-3 py-1 text-xs font-semibold ${emp.status=='Active'?'bg-green-100 text-green-800':'bg-red-100 text-red-800'} rounded-full">
                  <i class="fas fa-${emp.status=='Active'?'check-circle':'times-circle'} mr-1"></i>${safe(emp.status)}
                </span>
              </div>
            </div>
          </div>`;

        document.getElementById('employeeDetailsContent').innerHTML = `<div class="space-y-6">
          <div class="bg-white rounded-xl border border-gray-200 p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-address-book text-blue-600 mr-2"></i>Contact Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div><p class="text-xs text-gray-500">Email</p><p class="text-sm font-medium text-gray-900">${safe(emp.email)}</p></div>
              <div><p class="text-xs text-gray-500">Mobile</p><p class="text-sm font-medium text-gray-900">${safe(emp.mobilenumber)}</p></div>
              <div><p class="text-xs text-gray-500">Emergency Contact</p><p class="text-sm font-medium text-gray-900">${safe(emp.emergencycontact)}</p></div>
              <div><p class="text-xs text-gray-500">LinkedIn</p>${emp.linkedinurl? `<a class="text-blue-600 underline" href="${emp.linkedinurl}" target="_blank">View</a>`:'N/A'}</div>
            </div>
          </div>
          <div class="bg-white rounded-xl border border-gray-200 p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-briefcase text-green-600 mr-2"></i>Employment Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="bg-blue-50 rounded-lg p-4 border border-blue-200"><p class="text-xs text-blue-600">ID</p><p class="text-lg font-bold">${safe(emp.employmentid)}</p></div>
              <div class="bg-green-50 rounded-lg p-4 border border-green-200"><p class="text-xs text-green-600">Joining Date</p><p class="text-lg font-bold">${safe(emp.joiningdate)}</p></div>
              <div class="bg-purple-50 rounded-lg p-4 border border-purple-200"><p class="text-xs text-purple-600">Role</p><p class="text-lg font-bold">${safe(emp.role)}</p></div>
            </div>
          </div>
          <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border border-green-200 p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-rupee-sign text-green-600 mr-2"></i>Salary Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="bg-white rounded-lg p-6 border border-green-100"><p class="text-sm text-gray-600">Monthly Salary</p><p class="text-3xl font-bold text-green-600">â‚¹${emp.monthlysalary ? parseFloat(emp.monthlysalary).toFixed(2) : "0.00"}</p></div>
              <div class="bg-white rounded-lg p-6 border border-blue-100"><p class="text-sm text-gray-600">Yearly Salary</p><p class="text-3xl font-bold text-blue-600">â‚¹${emp.yearlysalary ? parseFloat(emp.yearlysalary).toFixed(2) : "0.00"}</p></div>
            </div>
          </div>
          <!-- Documents Section -->
          <div class="bg-white rounded-xl border border-gray-200 p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-folder-open text-orange-600 mr-2"></i>Employee Documents</h3>
            ${documents.length>0 ? 
              `<div class="space-y-2">${
                documents.map(doc => `
                  <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex items-center space-x-3">
                      <i class="fas fa-file-pdf text-red-500 text-2xl"></i>
                      <div><p class="text-sm font-semibold text-gray-900">${doc.name}</p><p class="text-xs text-gray-500">${doc.size_readable}</p></div>
                    </div>
                    <a href="view_employee_document/${encodeURIComponent(username)}/${encodeURIComponent(doc.name)}"
   target="_blank"
   class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs font-semibold">
   <i class="fas fa-eye mr-1"></i>View
</a>

                  </div>
                `).join('')
              }</div>`
              : `<div class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300"><i class="fas fa-folder-open text-4xl text-gray-300 mb-3"></i><p class="text-gray-500 font-medium">No documents uploaded</p></div>`
            }
          </div>
        </div>`;
      })
      .catch(error => {
        document.getElementById('employeeBasicInfo').innerHTML = '';
        document.getElementById('employeeDetailsContent').innerHTML =
          `<div class="text-center py-12"><i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
          <p class="text-red-600 text-lg font-bold mb-2">Error Loading Employee Details</p>
          <p class="text-gray-600 mb-4">${error.message}</p>
          <button onclick="closeEmployeeDetailsModal()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg"><i class="fas fa-times mr-1"></i>Close</button></div>`;
      });
}
// Add this function to enable closing the modal (X button and background/esc)
function closeEmployeeDetailsModal() {
    const modal = document.getElementById('employeeDetailsModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Optional: allow closing on click outside or ESC
document.addEventListener('click', function(e) {
    const modal = document.getElementById('employeeDetailsModal');
    if (modal && e.target === modal) {
        closeEmployeeDetailsModal();
    }
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEmployeeDetailsModal();
    }
});

function filterPayrollTable() {
    const input = document.getElementById("payrollEmployeeSearch");
    if (!input) return;

    const filter = input.value.toLowerCase().trim();
    const table = document.getElementById("payrollSalariesTable");
    if (!table) {
        console.warn("Payroll table not found - check if id='payrollSalariesTable' exists");
        return;
    }

    const rows = table.getElementsByTagName("tr");

    for (let i = 1; i < rows.length; i++) {  // skip header
        const nameCell = rows[i].getElementsByTagName("td")[1];  // NAME column = index 1

        if (nameCell) {
            const nameText = nameCell.textContent || nameCell.innerText;
            rows[i].style.display = nameText.toLowerCase().includes(filter) ? "" : "none";
        }
    }
}

</script>

<style>
    
/* Add this CSS to make custom categories stand out */
.custom-category {
    background: linear-gradient(45deg, #f3f4f6, #e5e7eb) !important;
    border-left: 3px solid #6366f1;
    font-weight: 600;
}

.other-category-field-animation {
    transition: all 0.3s ease-in-out;
    opacity: 0;
    transform: translateY(-10px);
}

.other-category-field-animation.show {
    opacity: 1;
    transform: translateY(0);
}

/* Enhance the category badges in the table */
.category-badge {
    transition: all 0.2s ease;
}

.category-badge:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}


.form-input, .form-select, .form-textarea {
    display: block;
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    line-height: 1.25rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.tab-button.active, .sub-tab-button.active {
    border-bottom-color: #2563eb;
    color: #2563eb;
}

.tab-button, .sub-tab-button {
    transition: all 0.2s;
}

.tab-button:hover, .sub-tab-button:hover {
    color: #374151;
    border-bottom-color: #d1d5db;
}

.transition-colors {
    transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, color 0.15s ease-in-out;
}


/* Scrollbar styling for employee select */
#hrEmployeeSelect {
    scrollbar-width: thin;
    scrollbar-color: #3B82F6 #F3F4F6;
}

#hrEmployeeSelect::-webkit-scrollbar {
    width: 8px;
}

#hrEmployeeSelect::-webkit-scrollbar-track {
    background: #F3F4F6;
    border-radius: 4px;
}

#hrEmployeeSelect::-webkit-scrollbar-thumb {
    background: #3B82F6;
    border-radius: 4px;
}

#hrEmployeeSelect::-webkit-scrollbar-thumb:hover {
    background: #2563EB;
}

#hrEmployeeSelect option {
    padding: 8px 12px;
}

#hrEmployeeSelect option:hover {
    background-color: #EFF6FF !important;
}

/* Scrollbar for modal content */
#hrAssignWorkModal .overflow-y-auto::-webkit-scrollbar {
    width: 10px;
}

#hrAssignWorkModal .overflow-y-auto::-webkit-scrollbar-track {
    background: #F9FAFB;
}

#hrAssignWorkModal .overflow-y-auto::-webkit-scrollbar-thumb {
    background: #D1D5DB;
    border-radius: 5px;
}

#hrAssignWorkModal .overflow-y-auto::-webkit-scrollbar-thumb:hover {
    background: #9CA3AF;
}


.overflow-x-auto {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
}

.overflow-x-auto::-webkit-scrollbar { height: 6px; }
.overflow-x-auto::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
.overflow-x-auto::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
.overflow-x-auto::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

tbody tr:hover {
    background-color: #f9fafb;
}

.max-w-xs {
    max-width: 20rem;
}

.truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.bg-yellow-25 {
    background-color: #fffbeb;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .grid-cols-6 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    
    .grid-cols-4 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    
    .grid-cols-3 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
    }
    
    .text-2xl {
        font-size: 1.5rem;
    }
    
    .px-6 {
        padding-left: 1rem;
        padding-right: 1rem;
    }
}

@media (max-width: 480px) {
    .space-x-8 {
        gap: 1rem;
    }
    
    .tab-button {
        font-size: 0.75rem;
        padding: 0.5rem 0.25rem;
    }
    
    .overflow-x-auto {
        font-size: 0.75rem;
    }
}

#employeeDetailsContent {
  scroll-behavior: smooth;
  max-height: calc(95vh - 200px);   /* Adjust this if your header + info block is taller/shorter */
}
#employeeDetailsContent::-webkit-scrollbar { width: 10px; }
#employeeDetailsContent::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
#employeeDetailsContent::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); border-radius: 10px; }
#employeeDetailsContent::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, #5568d3 0%, #653a8a 100%); }

</style>
</div>
</div>
{% endblock %}
